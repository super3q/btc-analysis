<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto AI Quant Analyst v6.0 â€” Elite Terminal</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg0: #060910;
    --bg1: #0c1017;
    --bg2: #111720;
    --bg3: #1a2232;
    --border: rgba(255,255,255,0.07);
    --border-bright: rgba(99,210,255,0.25);
    --green: #00e5a0;
    --green-dim: rgba(0,229,160,0.15);
    --red: #ff4466;
    --red-dim: rgba(255,68,102,0.15);
    --gold: #f5c542;
    --gold-dim: rgba(245,197,66,0.15);
    --blue: #63d2ff;
    --blue-dim: rgba(99,210,255,0.12);
    --purple: #b57bff;
    --text: #c8d8e8;
    --text-dim: #556070;
    --mono: 'Space Mono', monospace;
    --display: 'Syne', sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: var(--mono);
    background: var(--bg0);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px);
    pointer-events: none;
    z-index: 9999;
  }
  .container { max-width: 1800px; margin: 0 auto; padding: 24px; }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    display: flex; flex-direction: column; align-items: center;
    padding: 40px 0 30px;
    position: relative;
  }
  .header::after {
    content: '';
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 60%; height: 1px;
    background: linear-gradient(90deg, transparent, var(--blue), transparent);
  }
  .logo-row { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
  .logo-icon {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--blue), var(--purple));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
    box-shadow: 0 0 30px rgba(99,210,255,0.3);
  }
  h1 {
    font-family: var(--display); font-weight: 800; font-size: 2rem;
    background: linear-gradient(90deg, var(--blue) 0%, var(--purple) 50%, var(--green) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }
  .version-badge {
    font-size: 0.65rem; color: var(--text-dim); letter-spacing: 3px;
    text-transform: uppercase; margin-bottom: 20px;
    font-family: var(--mono);
  }

  /* â”€â”€ CONTROLS â”€â”€ */
  .controls-strip {
    display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
    gap: 12px; padding: 20px 0;
  }
  .search-wrap { position: relative; }
  .search-box {
    display: flex; align-items: center;
    background: var(--bg2); border: 1px solid var(--border-bright);
    border-radius: 8px; padding: 0 6px 0 16px;
    width: 320px;
    box-shadow: 0 0 20px rgba(99,210,255,0.08);
    transition: box-shadow 0.3s;
  }
  .search-box:focus-within { box-shadow: 0 0 30px rgba(99,210,255,0.2); }
  .search-input {
    background: none; border: none; color: #fff;
    font-family: var(--mono); font-size: 1rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 2px;
    flex: 1; padding: 12px 8px 12px 0; outline: none;
  }
  .search-input::placeholder { color: var(--text-dim); font-weight: 400; letter-spacing: 1px; }
  .search-btn {
    background: linear-gradient(135deg, var(--blue), #3a8bff);
    border: none; color: var(--bg0); font-family: var(--mono); font-weight: 700;
    padding: 8px 18px; border-radius: 6px; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    white-space: nowrap; font-size: 0.85rem;
  }
  .search-btn:hover { transform: scale(1.04); box-shadow: 0 4px 16px rgba(99,210,255,0.4); }
  .dropdown-list {
    position: absolute; top: calc(100% + 6px); left: 0; right: 0;
    background: var(--bg2); border: 1px solid var(--border-bright);
    border-radius: 8px; max-height: 240px; overflow-y: auto;
    display: none; z-index: 200;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  }
  .dropdown-item {
    padding: 10px 16px; cursor: pointer;
    display: flex; justify-content: space-between;
    font-size: 0.85rem; border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .dropdown-item:hover { background: var(--bg3); color: var(--blue); }

  .pill-group { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
  .coin-pill {
    font-family: var(--mono); font-size: 0.8rem; font-weight: 700;
    background: var(--bg2); border: 1px solid var(--border);
    color: var(--text-dim); padding: 6px 16px; border-radius: 6px;
    cursor: pointer; transition: all 0.2s;
  }
  .coin-pill:hover, .coin-pill.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }

  .tf-strip {
    display: flex; gap: 4px; background: var(--bg1);
    border: 1px solid var(--border); padding: 4px; border-radius: 8px;
  }
  .tf-pill {
    font-family: var(--mono); font-size: 0.78rem; font-weight: 700;
    background: none; border: 1px solid transparent; color: var(--text-dim);
    padding: 5px 14px; border-radius: 5px; cursor: pointer; transition: all 0.2s;
  }
  .tf-pill.active { background: var(--bg3); border-color: var(--border-bright); color: var(--blue); }

  .tv-link {
    display: inline-flex; align-items: center; gap: 8px;
    font-family: var(--mono); font-size: 0.78rem; color: var(--text-dim);
    background: var(--bg2); border: 1px solid var(--border);
    padding: 6px 16px; border-radius: 6px; text-decoration: none;
    transition: all 0.2s;
  }
  .tv-link:hover { border-color: var(--blue); color: var(--blue); }

  /* â”€â”€ LAYOUT â”€â”€ */
  .row { display: grid; gap: 16px; margin-bottom: 16px; }
  .row-top { grid-template-columns: 3fr 1fr; }
  .row-matrix { grid-template-columns: repeat(5, 1fr); }
  .row-bottom-grid { grid-template-columns: 1fr 1fr 1fr; }
  .row-fib-scan { grid-template-columns: 1fr 1fr; }

  .card {
    background: var(--bg1); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    position: relative; overflow: hidden;
  }
  .card::before {
    content: ''; position: absolute; inset: 0; pointer-events: none;
    background: radial-gradient(ellipse at 0% 0%, rgba(99,210,255,0.03) 0%, transparent 60%);
  }
  .card-title {
    font-family: var(--display); font-size: 0.85rem; font-weight: 700;
    color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
  }
  .card-title .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--blue); }

  /* â”€â”€ MAIN CHART â”€â”€ */
  .chart-card { height: 720px; padding: 16px; }
  .chart-card-inner { height: calc(100% - 40px); }
  .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .symbol-badge {
    font-family: var(--display); font-weight: 800; font-size: 1.5rem;
    color: var(--blue);
  }
  .tf-badge { font-size: 0.75rem; color: var(--text-dim); background: var(--bg2); padding: 4px 10px; border-radius: 4px; }

  /* â”€â”€ MARKET PULSE CARD â”€â”€ */
  .pulse-card { height: 720px; display: flex; flex-direction: column; gap: 16px; }

  .metric-block { background: var(--bg2); border-radius: 8px; padding: 14px; border: 1px solid var(--border); }
  .metric-label { font-size: 0.7rem; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .metric-val { font-family: var(--mono); font-size: 1.5rem; font-weight: 700; }
  .metric-val.green { color: var(--green); text-shadow: 0 0 20px rgba(0,229,160,0.4); }
  .metric-val.red { color: var(--red); text-shadow: 0 0 20px rgba(255,68,102,0.4); }
  .metric-val.gold { color: var(--gold); text-shadow: 0 0 20px rgba(245,197,66,0.3); }
  .metric-val.blue { color: var(--blue); }

  /* Pivot table */
  .pivot-tbl { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .pivot-tbl td { padding: 7px 8px; border-bottom: 1px solid var(--border); }
  .pivot-tbl td:last-child { font-family: var(--mono); font-weight: 700; text-align: right; }
  .lbl-r2 { color: var(--red); } .lbl-r1 { color: #ff8899; }
  .lbl-p { color: var(--gold); font-weight: 700; } .lbl-s1 { color: #88ffcc; } .lbl-s2 { color: var(--green); }

  /* OB bar */
  .ob-track { height: 10px; background: var(--bg0); border-radius: 5px; overflow: hidden; display: flex; margin: 8px 0 4px; }
  .ob-buy-seg { background: linear-gradient(90deg, var(--green), #00b575); height: 100%; transition: width 0.5s; }
  .ob-sell-seg { background: linear-gradient(90deg, #cc2244, var(--red)); height: 100%; transition: width 0.5s; }
  .ob-labels { display: flex; justify-content: space-between; font-size: 0.75rem; }

  /* â”€â”€ AI DECISION ENGINE â”€â”€ */
  .ai-card { }
  .ai-header-row {
    display: flex; justify-content: space-between; align-items: center;
    padding-bottom: 16px; margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .ai-title { font-family: var(--display); font-size: 1.2rem; font-weight: 800; color: #fff; }
  .ai-cols { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .ai-col { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; display: flex; flex-direction: column; }
  .ai-col-title { font-size: 0.7rem; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  .ai-score-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.83rem; padding: 7px 0; border-bottom: 1px solid var(--border); }
  .ai-score-row:last-child { border-bottom: none; }
  .badge { padding: 3px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
  .badge-bull { background: var(--green-dim); color: var(--green); border: 1px solid var(--green); }
  .badge-bear { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
  .badge-neu { background: var(--gold-dim); color: var(--gold); border: 1px solid var(--gold); }
  .badge-blue { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue); }

  /* Signal bar */
  .sig-track { height: 6px; background: var(--bg0); border-radius: 3px; margin: 8px 0 4px; overflow: hidden; }
  .sig-fill { height: 100%; border-radius: 3px; transition: width 0.7s ease-out, background 0.5s; }

  /* ATR box */
  .atr-box {
    margin-top: 12px; padding: 12px; border-radius: 8px;
    background: var(--red-dim); border: 1px solid rgba(255,68,102,0.3);
  }
  .atr-price { font-family: var(--mono); font-size: 1.6rem; font-weight: 700; color: var(--red); }

  /* Action text */
  .action-text { font-size: 0.88rem; line-height: 1.7; color: var(--text); flex-grow: 1; white-space: pre-line; }
  .rec-row { display: flex; justify-content: space-between; font-size: 0.82rem; padding: 6px 0; border-top: 1px solid var(--border); margin-top: 6px; }
  .rec-val { font-family: var(--mono); font-weight: 700; color: var(--blue); }

  /* â”€â”€ COMPOSITE SCORE PANEL â”€â”€ */
  .composite-bar-wrap {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; margin-bottom: 16px;
  }
  .composite-title { font-size: 0.7rem; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; }
  .indicators-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .ind-cell {
    background: var(--bg1); border: 1px solid var(--border);
    border-radius: 7px; padding: 10px 8px; text-align: center;
    transition: border-color 0.3s;
  }
  .ind-cell.bull { border-color: rgba(0,229,160,0.4); }
  .ind-cell.bear { border-color: rgba(255,68,102,0.3); }
  .ind-name { font-size: 0.68rem; color: var(--text-dim); margin-bottom: 4px; }
  .ind-val { font-family: var(--mono); font-size: 0.85rem; font-weight: 700; }
  .ind-val.green { color: var(--green); } .ind-val.red { color: var(--red); } .ind-val.gold { color: var(--gold); }

  /* â”€â”€ SECTION HEADER â”€â”€ */
  .section-header {
    display: flex; align-items: center; gap: 16px;
    margin: 32px 0 16px; padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .section-header h2 {
    font-family: var(--display); font-weight: 800; font-size: 1rem;
    color: #fff; letter-spacing: 1px; text-transform: uppercase;
  }
  .section-header .line {
    flex: 1; height: 1px;
    background: linear-gradient(90deg, var(--border-bright), transparent);
  }
  .section-header .tag {
    font-size: 0.65rem; color: var(--blue); letter-spacing: 2px;
    border: 1px solid var(--blue-dim); padding: 3px 10px; border-radius: 4px;
  }

  /* â”€â”€ MACRO MINI CHART CARDS â”€â”€ */
  .macro-card { height: 340px; padding: 10px; }

  /* â”€â”€ FUNDING RATE â”€â”€ */
  .funding-card {
    height: 340px; display: flex; flex-direction: column;
    background: linear-gradient(160deg, var(--bg1) 0%, var(--bg0) 100%);
    padding: 16px;
  }
  .funding-rate-big {
    font-family: var(--mono); font-size: 3rem; font-weight: 700;
    text-align: center; margin: auto 0;
  }
  .funding-badge {
    text-align: center; margin: 8px 0;
    font-size: 0.82rem; font-weight: 700; padding: 6px 14px;
    border-radius: 30px; border: 1px solid transparent;
  }
  .funding-countdown { text-align: center; font-size: 0.75rem; color: var(--text-dim); font-family: var(--mono); }
  .funding-hist td { padding: 5px 8px; font-size: 0.78rem; border-bottom: 1px solid var(--border); }

  /* â”€â”€ MACRO RULES â”€â”€ */
  .rule-card { padding: 18px; }
  .rule-card h4 { font-family: var(--display); font-size: 0.9rem; font-weight: 700; color: var(--blue); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
  .rule-card ul { padding-left: 16px; }
  .rule-card li { font-size: 0.82rem; color: var(--text); line-height: 1.65; margin-bottom: 7px; }
  .rule-card li::marker { color: var(--border-bright); }
  .txt-green { color: var(--green); font-weight: 700; }
  .txt-red { color: var(--red); font-weight: 700; }
  .txt-gold { color: var(--gold); font-weight: 700; }

  /* SOP */
  .sop-card {
    border: 1px solid rgba(245,197,66,0.25) !important;
    background: linear-gradient(135deg, var(--bg1), var(--bg0)) !important;
    padding: 20px;
  }
  .sop-card h4 { font-family: var(--display); font-weight: 700; color: var(--gold); margin-bottom: 16px; }
  .sop-items { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; }
  .sop-item {
    display: flex; align-items: center; gap: 10px;
    background: var(--gold-dim); border: 1px solid rgba(245,197,66,0.2);
    padding: 10px 20px; border-radius: 8px; font-size: 0.82rem;
    cursor: pointer; transition: background 0.2s;
  }
  .sop-item:hover { background: rgba(245,197,66,0.2); }
  .sop-item input[type="checkbox"] { transform: scale(1.3); cursor: pointer; accent-color: var(--gold); }

  /* â”€â”€ FIB TABLE â”€â”€ */
  .fib-card { }
  .fib-controls { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .fib-btn {
    font-family: var(--mono); font-size: 0.78rem;
    background: var(--bg2); border: 1px solid var(--border);
    color: var(--text-dim); padding: 5px 14px; border-radius: 5px;
    cursor: pointer; transition: all 0.2s;
  }
  .fib-btn.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }
  .fib-tbl { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .fib-tbl th { font-size: 0.7rem; color: var(--text-dim); padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; letter-spacing: 1px; }
  .fib-tbl td { padding: 10px; border-bottom: 1px solid var(--border); font-family: var(--mono); }
  .fib-buy { border-left: 3px solid var(--green); background: linear-gradient(90deg, rgba(0,229,160,0.06), transparent); }
  .fib-sell { border-left: 3px solid var(--red); background: linear-gradient(90deg, rgba(255,68,102,0.06), transparent); }
  .fib-near { color: var(--gold); font-weight: 700; }
  .dist-pos { color: var(--green); } .dist-neg { color: var(--red); }

  /* â”€â”€ BOTTOM SCANNER â”€â”€ */
  .scanner-card { }
  .gauge-strip { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
  .gauge-pill {
    font-family: var(--mono); font-size: 0.75rem;
    background: var(--bg2); border: 1px solid var(--border);
    color: var(--text-dim); padding: 4px 12px; border-radius: 4px;
    cursor: pointer; transition: all 0.2s;
  }
  .gauge-pill.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }
  .scanner-tbl { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
  .scanner-tbl th { font-size: 0.7rem; color: var(--text-dim); padding: 8px 12px; border-bottom: 1px solid var(--border); letter-spacing: 1px; font-weight: 400; }
  .scanner-tbl td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  .scanner-tbl td:last-child { font-family: var(--mono); font-weight: 700; text-align: right; }
  .sig-b { color: var(--green); background: var(--green-dim); padding: 3px 10px; border-radius: 4px; }
  .sig-s { color: var(--red); background: var(--red-dim); padding: 3px 10px; border-radius: 4px; }
  .sig-n { color: var(--text-dim); background: var(--bg2); padding: 3px 10px; border-radius: 4px; }

  /* â”€â”€ VOLATILITY & PATTERN BOX â”€â”€ */
  .extra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
  .mini-stat { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
  .mini-stat-label { font-size: 0.68rem; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
  .mini-stat-val { font-family: var(--mono); font-size: 1.1rem; font-weight: 700; color: #fff; }

  /* â”€â”€ MULTI-TF TREND MATRIX â”€â”€ */
  .matrix-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 12px; }
  .mtf-cell {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 7px; padding: 10px; text-align: center;
  }
  .mtf-tf { font-size: 0.68rem; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 1px; }
  .mtf-val { font-family: var(--mono); font-size: 0.8rem; font-weight: 700; }

  /* â”€â”€ LOADING â”€â”€ */
  @keyframes pulse { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
  .loading { color: var(--blue); animation: pulse 1.2s infinite; font-size: 0.8rem; }

  /* â”€â”€ GLOW EFFECTS â”€â”€ */
  @keyframes glow { 0%,100% { box-shadow: 0 0 10px rgba(99,210,255,0.1); } 50% { box-shadow: 0 0 25px rgba(99,210,255,0.25); } }
  .glow-card { animation: glow 4s ease-in-out infinite; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg0); }
  ::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 2px; }

  @media (max-width: 1400px) {
    .row-top { grid-template-columns: 1fr; }
    .row-matrix { grid-template-columns: repeat(3, 1fr); }
    .ai-cols { grid-template-columns: 1fr; }
    .chart-card { height: 500px; }
    .pulse-card { height: auto; }
  }
  @media (max-width: 900px) {
    .row-matrix { grid-template-columns: 1fr 1fr; }
    .row-bottom-grid { grid-template-columns: 1fr; }
    .row-fib-scan { grid-template-columns: 1fr; }
    .indicators-grid { grid-template-columns: repeat(2, 1fr); }
    .matrix-grid { grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 600px) {
    .row-matrix { grid-template-columns: 1fr; }
    h1 { font-size: 1.4rem; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-row">
      <div class="logo-icon">âš¡</div>
      <h1>CRYPTO AI QUANT</h1>
    </div>
    <div class="version-badge">v6.0 ELITE TERMINAL &nbsp;â€¢&nbsp; BINANCE API &nbsp;â€¢&nbsp; REAL-TIME</div>
    
    <div class="controls-strip">
      <div class="search-wrap">
        <div class="search-box">
          <input type="text" id="symbol-input" class="search-input" placeholder="æœå°‹å¹£ç¨®..." autocomplete="off">
          <button class="search-btn" onclick="triggerSearch()">SCAN</button>
        </div>
        <div id="dropdown-list" class="dropdown-list"></div>
      </div>

      <a id="tv-link" href="#" target="_blank" class="tv-link">ğŸ”— TradingView</a>

      <div class="pill-group" id="quick-coins">
        <button class="coin-pill active" onclick="quickLoad('BTC',this)">BTC</button>
        <button class="coin-pill" onclick="quickLoad('ETH',this)">ETH</button>
        <button class="coin-pill" onclick="quickLoad('SOL',this)">SOL</button>
        <button class="coin-pill" onclick="quickLoad('BNB',this)">BNB</button>
        <button class="coin-pill" onclick="quickLoad('DOGE',this)">DOGE</button>
        <button class="coin-pill" onclick="quickLoad('XRP',this)">XRP</button>
        <button class="coin-pill" onclick="quickLoad('ADA',this)">ADA</button>
        <span id="load-ind" class="loading" style="display:none;">âš¡ è¨ˆç®—ä¸­...</span>
      </div>

      <div class="tf-strip">
        <button class="tf-pill" onclick="switchTF('15m',this)">15m</button>
        <button class="tf-pill" onclick="switchTF('1h',this)">1H</button>
        <button class="tf-pill active" onclick="switchTF('4h',this)">4H</button>
        <button class="tf-pill" onclick="switchTF('1d',this)">1D</button>
        <button class="tf-pill" onclick="switchTF('1M',this)">1M</button>
        <button class="tf-pill" onclick="switchTF('1Y',this)">1Y</button>
      </div>
    </div>
  </div>

  <!-- TOP ROW: Chart + Market Pulse -->
  <div class="row row-top">
    <div class="card chart-card">
      <div class="chart-header">
        <div>
          <span class="symbol-badge" id="main-symbol-lbl">BTC</span>
          <span style="color:var(--text-dim); font-size:0.85rem;">/USDT</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="tf-badge tf-display">4H (æ³¢æ®µ)</span>
          <span style="font-size:0.7rem;color:var(--text-dim);">Auto Fib âœ“ MACD âœ“ RSI âœ“</span>
        </div>
      </div>
      <div class="chart-card-inner" id="tv-chart-container"></div>
    </div>

    <div class="card pulse-card">
      <div class="card-title"><span class="dot"></span>å¸‚å ´è„ˆè¡æ¿</div>

      <!-- Current Price + Change -->
      <div class="metric-block">
        <div class="metric-label">å³æ™‚åƒ¹æ ¼</div>
        <div class="metric-val blue" id="live-price">---</div>
        <div style="font-size:0.8rem;margin-top:4px;" id="price-change">---</div>
      </div>

      <!-- Order Book -->
      <div class="metric-block">
        <div class="metric-label">è²·è³£æ›å–®å£“åŠ› (Order Book)</div>
        <div class="ob-track">
          <div id="ob-buy-bar" class="ob-buy-seg" style="width:50%"></div>
          <div id="ob-sell-bar" class="ob-sell-seg" style="width:50%"></div>
        </div>
        <div class="ob-labels">
          <span style="color:var(--green);">è²· <span id="ob-buy-pct" style="font-family:var(--mono);font-weight:700;">--%</span></span>
          <span style="color:var(--red);">è³£ <span id="ob-sell-pct" style="font-family:var(--mono);font-weight:700;">--%</span></span>
        </div>
      </div>

      <!-- Pivot Points -->
      <div class="metric-block" style="flex-grow:1;">
        <div class="metric-label">æ©Ÿæ§‹æ¨è»¸é» (Pivot)</div>
        <table class="pivot-tbl" style="margin-top:6px;">
          <tr><td class="lbl-r2">R2 å¼·å£“åŠ›</td><td id="pp-r2">---</td></tr>
          <tr><td class="lbl-r1">R1 å£“åŠ›</td><td id="pp-r1">---</td></tr>
          <tr><td class="lbl-p">P  ä¸­è»¸</td><td id="pp-p">---</td></tr>
          <tr><td class="lbl-s1">S1 æ”¯æ’</td><td id="pp-s1">---</td></tr>
          <tr><td class="lbl-s2">S2 å¼·æ”¯æ’</td><td id="pp-s2">---</td></tr>
          <tr><td style="color:var(--purple);">R3 æ¥µå£“åŠ›</td><td id="pp-r3">---</td></tr>
          <tr><td style="color:#77ff99;">S3 æ¥µæ”¯æ’</td><td id="pp-s3">---</td></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- COMPOSITE INDICATOR GRID -->
  <div class="composite-bar-wrap">
    <div class="composite-title">ç¶œåˆæŠ€è¡“æŒ‡æ¨™å¿«é€Ÿæƒæ â€” <span class="tf-display" style="color:var(--blue);">4H</span></div>
    <div class="indicators-grid" id="indicators-grid">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- AI DECISION ENGINE -->
  <div class="card ai-card" style="margin-bottom:16px;">
    <div class="ai-header-row">
      <div>
        <div class="ai-title">ğŸ§  AI æ ¸å¿ƒé‚è¼¯æ±ºç­–å¼•æ“</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">Binance Klines Ã— ATR Risk Model Ã— Multi-Indicator Fusion</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="tf-badge tf-display">4H (æ³¢æ®µ)</span>
        <span id="overall-badge" class="badge badge-neu">æƒæä¸­</span>
      </div>
    </div>
    <div class="ai-cols">
      <!-- Col 1: Trend -->
      <div class="ai-col">
        <div class="ai-col-title">1. è¶¨å‹¢çŸ©é™£ & ä¿¡å¿ƒæŒ‡æ•¸</div>
        <div id="trend-display" style="font-size:1.1rem;margin-bottom:12px;">---</div>
        <div>
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:4px;">
            <span>è¨Šè™Ÿå¼·åº¦</span><span id="signal-val" style="color:var(--blue);">0%</span>
          </div>
          <div class="sig-track"><div id="signal-bar" class="sig-fill" style="width:0%"></div></div>
        </div>
        <div style="margin-top:12px;">
          <div class="ai-score-row"><span>MA99 é•·ç·š</span><span id="score-ma99">â¬œ</span></div>
          <div class="ai-score-row"><span>MA25 ä¸­ç·š</span><span id="score-ma25">â¬œ</span></div>
          <div class="ai-score-row"><span>MA7 çŸ­ç·š</span><span id="score-ma7">â¬œ</span></div>
          <div class="ai-score-row"><span>RSI ç‹€æ…‹</span><span id="score-rsi">---</span></div>
          <div class="ai-score-row"><span>MACD æ–¹å‘</span><span id="score-macd">---</span></div>
          <div class="ai-score-row"><span>å¸ƒæ—é€šé“</span><span id="score-bb">---</span></div>
        </div>
      </div>

      <!-- Col 2: Risk -->
      <div class="ai-col">
        <div class="ai-col-title">2. é¢¨éšªè©•ä¼° & é—œéµæŒ‡æ¨™</div>
        <div class="ai-score-row"><span>Kç·šå‹æ…‹</span><span id="pattern-res" style="color:#fff;">æƒæä¸­...</span></div>
        <div class="ai-score-row"><span>æˆäº¤é‡</span><span id="vol-status">---</span></div>
        <div class="ai-score-row"><span>æ³¢å‹•ç‡(ATR%)</span><span id="atr-pct">---</span></div>
        <div class="ai-score-row"><span>è¶¨å‹¢å¼·åº¦(ADX)</span><span id="adx-val">---</span></div>
        <div class="ai-score-row"><span>Stoch RSI</span><span id="stochrsi-val">---</span></div>
        <div class="atr-box" style="margin-top:12px;">
          <div class="metric-label">ATR å‹•æ…‹é˜²ç¦¦æ­¢æ (2.5Ã—)</div>
          <div class="atr-price" id="atr-sl-price">---</div>
          <div style="font-size:0.7rem;color:var(--text-dim);margin-top:4px;">*é˜²æ©Ÿæ§‹æƒ¡æ„åˆºç©¿æƒæ</div>
        </div>
        <div class="extra-grid">
          <div class="mini-stat">
            <div class="mini-stat-label">ATR å€¼</div>
            <div class="mini-stat-val" id="atr-raw">---</div>
          </div>
          <div class="mini-stat">
            <div class="mini-stat-label">æ³¢å‹•å¹…åº¦</div>
            <div class="mini-stat-val" id="range-24h">---</div>
          </div>
        </div>
      </div>

      <!-- Col 3: Action -->
      <div class="ai-col" style="border-color:rgba(99,210,255,0.3);">
        <div class="ai-col-title" style="color:var(--blue);">3. AI å¯¦æˆ°æ“ä½œå»ºè­°</div>
        <div id="ai-action-text" class="action-text">åˆ†æä¸­...</div>
        <div style="margin-top:auto;">
          <div class="rec-row"><span>é€²å ´å€é–“</span><span class="rec-val" id="rec-buy">---</span></div>
          <div class="rec-row"><span>æ­¢ç›ˆç›®æ¨™</span><span class="rec-val" id="rec-sell">---</span></div>
          <div class="rec-row"><span>é¢¨å ±æ¯”</span><span class="rec-val" id="risk-reward">---</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MULTI-TF TREND MATRIX -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title"><span class="dot"></span>å¤šé€±æœŸè¶¨å‹¢çŸ©é™£ (Multi-Timeframe Matrix)</div>
    <div class="matrix-grid" id="mtf-grid">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- MACRO MATRIX HEADER -->
  <div class="section-header">
    <h2>ğŸ¦ è¯çˆ¾è¡—æ©Ÿæ§‹æµå‹•æ€§çŸ©é™£</h2>
    <div class="line"></div>
    <span class="tag">TOP-DOWN MACRO</span>
  </div>

  <div class="row row-matrix">
    <!-- VIX -->
    <div class="card macro-card">
      <div class="tradingview-widget-container" style="height:100%;width:100%;">
        <div class="tradingview-widget-container__widget" style="height:100%;width:100%;"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
        {"symbols":[["ğŸ“‰ VIX ææ…Œ","CAPITALCOM:VIX|3M"]],"chartOnly":false,"width":"100%","height":"100%","locale":"zh_TW","colorTheme":"dark","autosize":true,"showVolume":false,"hideDateRanges":false,"hideSymbolLogo":true,"scalePosition":"right","scaleMode":"Normal","fontFamily":"monospace","fontSize":"10","valuesTracking":"1","changeMode":"price-and-percent","chartType":"area","lineColor":"#ff4466","bottomColor":"rgba(255,68,102,0)","topColor":"rgba(255,68,102,0.25)","lineWidth":2}
        </script>
      </div>
    </div>
    <!-- NQ -->
    <div class="card macro-card">
      <div class="tradingview-widget-container" style="height:100%;width:100%;">
        <div class="tradingview-widget-container__widget" style="height:100%;width:100%;"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
        {"symbols":[["ğŸ“ˆ NQ100","CAPITALCOM:US100|3M"]],"chartOnly":false,"width":"100%","height":"100%","locale":"zh_TW","colorTheme":"dark","autosize":true,"showVolume":false,"hideDateRanges":false,"hideSymbolLogo":true,"scalePosition":"right","scaleMode":"Normal","fontFamily":"monospace","fontSize":"10","valuesTracking":"1","changeMode":"price-and-percent","chartType":"candlesticks","upColor":"#00e5a0","downColor":"#ff4466","borderUpColor":"#00e5a0","borderDownColor":"#ff4466","wickUpColor":"#00e5a0","wickDownColor":"#ff4466"}
        </script>
      </div>
    </div>
    <!-- DXY -->
    <div class="card macro-card">
      <div class="tradingview-widget-container" style="height:100%;width:100%;">
        <div class="tradingview-widget-container__widget" style="height:100%;width:100%;"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
        {"symbols":[["ğŸ’µ DXY","CAPITALCOM:DXY|3M"]],"chartOnly":false,"width":"100%","height":"100%","locale":"zh_TW","colorTheme":"dark","autosize":true,"showVolume":false,"hideDateRanges":false,"hideSymbolLogo":true,"scalePosition":"right","scaleMode":"Normal","fontFamily":"monospace","fontSize":"10","valuesTracking":"1","changeMode":"price-and-percent","chartType":"area","lineColor":"#00e5a0","bottomColor":"rgba(0,229,160,0)","topColor":"rgba(0,229,160,0.2)","lineWidth":2}
        </script>
      </div>
    </div>
    <!-- US10Y -->
    <div class="card macro-card">
      <div class="tradingview-widget-container" style="height:100%;width:100%;">
        <div class="tradingview-widget-container__widget" style="height:100%;width:100%;"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
        {"symbols":[["ğŸ›ï¸ US10Y","FRED:DGS10|3M"]],"chartOnly":false,"width":"100%","height":"100%","locale":"zh_TW","colorTheme":"dark","autosize":true,"showVolume":false,"hideDateRanges":false,"hideSymbolLogo":true,"scalePosition":"right","scaleMode":"Normal","fontFamily":"monospace","fontSize":"10","valuesTracking":"1","changeMode":"price-and-percent","chartType":"area","lineColor":"#f5c542","bottomColor":"rgba(245,197,66,0)","topColor":"rgba(245,197,66,0.2)","lineWidth":2}
        </script>
      </div>
    </div>
    <!-- Funding Rate -->
    <div class="card funding-card">
      <div class="card-title"><span class="dot"></span>è³‡é‡‘è²»ç‡ <span class="coin-name" style="color:var(--blue);">BTC</span></div>
      <div class="funding-rate-big" id="live-funding-rate">---</div>
      <div class="funding-badge" id="funding-status">åŠ è¼‰ä¸­...</div>
      <div class="funding-countdown" id="funding-countdown">ä¸‹æ¬¡çµç®—: --:--:--</div>
      <table class="funding-hist" style="width:100%;border-collapse:collapse;margin-top:10px;">
        <thead><tr><td colspan="2" style="font-size:0.7rem;color:var(--text-dim);padding:4px 8px;border-bottom:1px solid var(--border);">æ­·å²è²»ç‡</td></tr></thead>
        <tbody id="funding-history"><tr><td colspan="2" style="padding:8px;font-size:0.78rem;color:var(--text-dim);">è®€å–ä¸­...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- MACRO RULES -->
  <div class="row row-bottom-grid" style="margin-bottom:16px;">
    <div class="card rule-card">
      <h4>ç¬¬ä¸€æ­¥ï¼šVIX æ±ºå®šæ’é‡æ·±åº¦</h4>
      <ul>
        <li><span class="txt-green">VIX &lt; 15</span>ï¼šæ¨‚è§€ï¼Œç„¡æ·±åº¦ä¸‹æ®ºï¼Œä¸»åŠ›æº«æ°´ç…®é’è›™èª˜å¤šã€‚</li>
        <li><span class="txt-gold">VIX 15â€“20</span>ï¼šå¥åº·éœ‡ç›ªï¼Œæ’é‡æ·±åº¦ç´„ç¾è‚¡è·Œå¹…3å€ã€‚</li>
        <li><span class="txt-red">VIX 20â€“25</span>ï¼šè­¦æˆ’ï¼å–®æ—¥æ˜“æ®º10%ï¼Œæ·±æ°´å€ç¶²æ ¼é€²å…¥å°„ç¨‹ã€‚</li>
        <li><span style="color:#ff1144;font-weight:700;">VIX &gt; 30</span>ï¼šé»‘å¤©éµï¼ç„¡å·®åˆ¥æ‹‹å”®ï¼Œç¢ºä¿ä¿è­‰é‡‘èƒ½æ‰›ä½çµ‚æ¥µé˜²ç·šã€‚</li>
      </ul>
    </div>
    <div class="card rule-card">
      <h4>ç¬¬äºŒæ­¥ï¼šNQ æ±ºå®šçœŸå¯¦å‹•å‘</h4>
      <ul>
        <li><span class="txt-green">é•·ä¸‹å½±ç·šå®ˆæ”¯æ’</span>ï¼šç¾è‚¡æœ‰è²·ç›¤æ‰¿æ¥ï¼ŒBTCä¸‹æ®ºé€šå¸¸æ˜¯å‡è·Œç ´ï¼Œå³å°‡åå½ˆã€‚</li>
        <li><span class="txt-red">å¯¦é«”å¤§é»‘KçŒç ´æ”¯æ’</span>ï¼šè¯çˆ¾è¡—å¯¦è³ªæ’¤è³‡ï¼ä»»ä½•æ‹‰æŠ¬çš†ç‚ºé€ƒå‘½æ³¢ï¼Œåš´ç¦åšå¤šã€‚</li>
        <li><span class="txt-gold">é«˜é»æŒçºŒé™ä½</span>ï¼šä¸‹é™è¶¨å‹¢ç¢ºèªï¼Œç­‰å¾…çµæ§‹è½‰æ›å†é€²å ´ã€‚</li>
      </ul>
    </div>
    <div class="card rule-card">
      <h4>ç¬¬ä¸‰æ­¥ï¼šUS10Y & DXY è³‡é‡‘æ°´é¾é ­</h4>
      <ul>
        <li><span class="txt-red">US10Y &gt; 4.0% ä¸” DXY å¼·å‹¢ç«™ç©© 97</span>ï¼šè³‡é‡‘æˆæœ¬é«˜ï¼Œä¸»åŠ›ä¸æœƒèŠ±å¤§éŒ¢æ‹‰æŠ¬BTCï¼Œå‡çªç ´æ©Ÿç‡æ¥µé«˜ã€‚</li>
        <li><span class="txt-green">US10Y &lt; 3.8% ä¸” DXY ç‹‚è·Œ</span>ï¼šè³‡é‡‘æ°´é¾é ­å¤§é–‹ï¼Œç‰›å¸‚å•Ÿå‹•ç‡ƒæ–™å……è¶³ï¼Œå¯å¤§è†½è¿½å¤šã€‚</li>
      </ul>
    </div>
    <div class="card rule-card">
      <h4>ç¬¬å››æ­¥ï¼šè³‡é‡‘è²»ç‡å®šç‡ƒæ–™æ–¹å‘</h4>
      <ul>
        <li><span class="txt-red">è²»ç‡ &gt; 0.015%</span>ï¼šèª˜å¤šç‡ƒæ–™éç†±ï¼Œæ•£æˆ¶ç„¡è…¦é€†å‹¢å¤šï¼Œä¸»åŠ›å¿…æ®ºä¹‹ã€‚</li>
        <li><span class="txt-green">è²»ç‡ &lt; 0%</span>ï¼šçµ•æœ›è² è²»ç‡ï¼Œç©ºè»èšé›†ï¼Œå³å°‡å‘ä¸Šè»‹ç©ºçš„é»ƒé‡‘æ™‚åˆ»ã€‚</li>
        <li><span class="txt-gold">è²»ç‡ 0â€“0.01%</span>ï¼šæƒ…ç·’ä¸­æ€§ï¼Œæ ¹æ“šæŠ€è¡“é¢ç‚ºä¸»è¦åƒè€ƒä¾æ“šã€‚</li>
      </ul>
    </div>
    <div class="card rule-card">
      <h4>ç¬¬äº”æ­¥ï¼šé‡åƒ¹é—œä¿‚åˆ¤è®€</h4>
      <ul>
        <li><span class="txt-green">æ”¾é‡çªç ´</span>ï¼šä¸»åŠ›æ¨å‹•ï¼Œæ–¹å‘å¯ä¿¡ï¼Œé †å‹¢è¿½å–®ã€‚</li>
        <li><span class="txt-red">ç¸®é‡çªç ´</span>ï¼šå‡çªç ´è­¦å‘Šï¼æƒœå”®æˆ–ç„¡äººæ¥æ‰‹ï¼Œå›èª¿æ©Ÿç‡é«˜é”70%+ã€‚</li>
        <li><span class="txt-gold">åº•éƒ¨æ”¾é‡é•·ä¸‹å½±ç·š</span>ï¼šä¸»åŠ›å¸ç±Œä¿¡è™Ÿï¼Œå¯åˆ†æ‰¹å¸ƒå±€å¤šå–®ã€‚</li>
        <li><span style="color:var(--text-dim);">é«˜ä½æ”¾é‡é•·ä¸Šå½±ç·š</span>ï¼šä¸»åŠ›å‡ºè²¨ï¼Œæ¸›å€‰ä¿¡è™Ÿæ˜ç¢ºã€‚</li>
      </ul>
    </div>
    <div class="card sop-card" style="grid-column:1/-1;">
      <h4>âœ… æ¯æ—¥ä¸‰åˆ†é˜ SOP æª¢æ ¸è¡¨</h4>
      <div class="sop-items">
        <label class="sop-item"><input type="checkbox"> VIX æœ‰æ²’æœ‰é 20ï¼Ÿ<br><span style="font-size:0.75rem;color:var(--text-dim);">æ±ºå®šæœ‰ç„¡æ·±åº¦æ’é‡</span></label>
        <label class="sop-item"><input type="checkbox"> NQ é—œéµæ”¯æ’ç ´äº†å—ï¼Ÿ<br><span style="font-size:0.75rem;color:var(--text-dim);">æ±ºå®šé€¢é«˜ç©ºæˆ–é€¢ä½è²·</span></label>
        <label class="sop-item"><input type="checkbox"> US10Y åœ¨ 4% ä»¥ä¸Šå—ï¼Ÿ<br><span style="font-size:0.75rem;color:var(--text-dim);">ç¢ºèªå‡çªç ´é‚è¼¯</span></label>
        <label class="sop-item"><input type="checkbox"> è³‡é‡‘è²»ç‡æ˜¯å¦éç†±ï¼Ÿ<br><span style="font-size:0.75rem;color:var(--text-dim);">æ±ºå®šå¸‚å ´ç‡ƒæ–™æ–¹å‘</span></label>
        <label class="sop-item"><input type="checkbox"> æˆäº¤é‡æ˜¯å¦æ”¾å¤§ï¼Ÿ<br><span style="font-size:0.75rem;color:var(--text-dim);">ç¢ºèªçªç ´çœŸå¯¦æ€§</span></label>
      </div>
    </div>
  </div>

  <!-- FIB + SCANNER -->
  <div class="row row-fib-scan">
    <!-- FIB -->
    <div class="card fib-card">
      <div class="card-title"><span class="dot"></span>æ–æ³¢é‚£å¥‘å›æ’¤ Pro</div>
      <div class="fib-controls">
        <button class="fib-btn" onclick="calcFib('1h',200,this)">1H çŸ­ç·š</button>
        <button class="fib-btn active" onclick="calcFib('4h',200,this)">4H æ³¢æ®µ</button>
        <button class="fib-btn" onclick="calcFib('1d',100,this)">1D æ—¥ç·š</button>
        <button class="fib-btn" onclick="calcFib('1w',100,this)">1W é€±ç·š</button>
        <span id="fib-loading" class="loading" style="display:none;">è¨ˆç®—ä¸­...</span>
      </div>
      <table class="fib-tbl">
        <thead><tr><th>Level</th><th>Price</th><th>æè¿°</th><th>è·é›¢</th><th>å¼·å¼±</th></tr></thead>
        <tbody id="fib-body"></tbody>
      </table>
    </div>

    <!-- SCANNER -->
    <div class="card scanner-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;"><span class="dot"></span>ç¨ç«‹æŒ‡æ¨™è©³ç´°æƒæ</div>
        <div class="gauge-strip">
          <button class="gauge-pill" onclick="updateBottom('15m',this)">15m</button>
          <button class="gauge-pill" onclick="updateBottom('1h',this)">1H</button>
          <button class="gauge-pill active" onclick="updateBottom('4h',this)">4H</button>
          <button class="gauge-pill" onclick="updateBottom('1D',this)">1D</button>
          <button class="gauge-pill" onclick="updateBottom('1W',this)">1W</button>
          <button class="gauge-pill" onclick="updateBottom('1M',this)">1M</button>
        </div>
      </div>
      <div id="tv-gauge-bottom" style="height:380px;width:100%;"></div>
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
        <span id="bottom-loading" class="loading" style="display:none;">è¨ˆç®—ä¸­...</span>
        <table class="scanner-tbl" id="scanner-body">
          <thead><tr><th>æŒ‡æ¨™</th><th>æ•¸å€¼</th><th>è¨Šè™Ÿ</th></tr></thead>
          <tbody id="scanner-rows"></tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /container -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentCoin = 'BTC';
let currentSymbol = 'BTCUSDT';
let currentTF = '4h';
let allSymbols = [];
let fundingTimer = null;

const TF = {
  '15m':{ bin:'15m', tv:'15',  lbl:'15m (çŸ­ç·š)' },
  '1h': { bin:'1h',  tv:'60',  lbl:'1H (ç•¶æ²–)'  },
  '4h': { bin:'4h',  tv:'240', lbl:'4H (æ³¢æ®µ)'  },
  '1d': { bin:'1d',  tv:'D',   lbl:'1D (æ—¥ç·š)'  },
  '1M': { bin:'12h', tv:'240', lbl:'1M (æœˆæ¬¡)'  },
  '1Y': { bin:'1w',  tv:'W',   lbl:'1Y (å¹´ç·š)'  },
};

window.onload = () => { quickLoad('BTC', document.querySelector('.coin-pill')); initSearch(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initSearch() {
  const input = document.getElementById('symbol-input');
  const list  = document.getElementById('dropdown-list');
  try {
    const data = await (await fetch('https://api.binance.com/api/v3/exchangeInfo')).json();
    allSymbols = data.symbols.filter(s=>s.quoteAsset==='USDT'&&s.status==='TRADING').map(s=>s.baseAsset).sort();
  } catch(e){}
  input.addEventListener('input', function(){
    const v = this.value.toUpperCase();
    if(!v){ list.style.display='none'; return; }
    const m = allSymbols.filter(s=>s.startsWith(v)).slice(0,50);
    list.innerHTML = m.map(s=>`<div class="dropdown-item" onclick="selectSym('${s}')">${s}<span style="color:var(--text-dim);font-size:0.75rem;">USDT</span></div>`).join('');
    list.style.display = m.length ? 'block' : 'none';
  });
  document.addEventListener('click', e=>{ if(!input.contains(e.target)&&!list.contains(e.target)) list.style.display='none'; });
}
function selectSym(c){ document.getElementById('symbol-input').value=c; document.getElementById('dropdown-list').style.display='none'; quickLoad(c); }
function triggerSearch(){ const v=document.getElementById('symbol-input').value.trim().toUpperCase(); if(v) quickLoad(v); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD & REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickLoad(coin, btn) {
  currentCoin = coin; currentSymbol = coin+'USDT';
  document.querySelectorAll('.coin-name').forEach(el=>el.innerText=coin);
  document.getElementById('main-symbol-lbl').innerText = coin;
  document.getElementById('tv-link').href = `https://tw.tradingview.com/symbols/${coin}USDT/?exchange=BINANCE`;
  if(btn){ document.querySelectorAll('.coin-pill').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
  refreshAll();
  calcFib('4h',200, document.querySelectorAll('.fib-btn')[1]);
  fetchMTFMatrix();
}

function switchTF(tf, el) {
  currentTF = tf;
  document.querySelectorAll('.tf-pill').forEach(b=>b.classList.remove('active')); el.classList.add('active');
  document.querySelectorAll('.tf-display').forEach(e=>e.innerText=TF[tf]?TF[tf].lbl:tf);
  refreshAll();
}

function refreshAll() {
  showLoad(true);
  reloadMainChart();
  runQuant().then(()=>showLoad(false));
  fetchOB();
  fetchFunding();
  fetchLivePrice();
}
function showLoad(on){ document.getElementById('load-ind').style.display = on?'inline':'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function reloadMainChart() {
  const c = document.getElementById('tv-chart-container');
  c.innerHTML='';
  const d = document.createElement('div');
  d.className='tradingview-widget-container';
  d.style.cssText='height:100%;width:100%;';
  d.innerHTML='<div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div>';
  const s = document.createElement('script');
  s.src='https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
  s.async=true;
  s.innerHTML=JSON.stringify({
    autosize:true, symbol:'BINANCE:'+currentSymbol,
    interval: TF[currentTF]?TF[currentTF].tv:'240',
    timezone:'Asia/Taipei', theme:'dark', style:'1', locale:'zh_TW',
    enable_publishing:false, withdateranges:true, hide_side_toolbar:false,
    studies:[
      'MASimple@tv-basicstudies','MASimple@tv-basicstudies','MASimple@tv-basicstudies',
      'MACD@tv-basicstudies','RSI@tv-basicstudies','BB@tv-basicstudies',
      'AutoFibRetracement@tv-basicstudies','Volume@tv-basicstudies'
    ],
    support_host:'https://www.tradingview.com'
  });
  d.appendChild(s); c.appendChild(d);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUANT ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runQuant() {
  try {
    const interval = TF[currentTF]?TF[currentTF].bin:'4h';
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${interval}&limit=200`);
    if(!r.ok) return;
    const data = await r.json();

    const C = data.map(d=>parseFloat(d[4]));
    const H = data.map(d=>parseFloat(d[2]));
    const L = data.map(d=>parseFloat(d[3]));
    const V = data.map(d=>parseFloat(d[5]));
    const O = data.map(d=>parseFloat(d[1]));

    const cur = C[C.length-1];
    const ma7  = calcMA(C,7), ma25=calcMA(C,25), ma99=calcMA(C,99);
    const ema12=calcEMA(C,12), ema26=calcEMA(C,26);
    const macd = ema12 - ema26;
    const macdSignal = calcEMA(
      C.slice(-50).map((_,i,a)=>i>=11 ? calcEMA(a.slice(0,i+1),12)-calcEMA(a.slice(0,i+1),26) : null).filter(v=>v!==null),
      9
    );
    const rsi14 = calcRSI(C,14);
    const atr14 = calcATR(H,L,C,14);
    const atrPct= (atr14/cur*100).toFixed(2);
    const bb    = calcBB(C,20,2);
    const stochK= calcStochRSI(C,14,3);

    // ADX approximation
    const adx = calcADX(H,L,C,14);

    // Volume analysis
    const avgVol = V.slice(-20).reduce((a,b)=>a+b,0)/20;
    const curVol = V[V.length-1];
    const volRatio = (curVol/avgVol).toFixed(2);

    // Pivot
    const ph=H[H.length-2], pl=L[L.length-2], pc=C[C.length-2];
    const pp=(ph+pl+pc)/3;
    const r1=2*pp-pl, r2=pp+(ph-pl), r3=ph+2*(pp-pl);
    const s1=2*pp-ph, s2=pp-(ph-pl), s3=pl-2*(ph-pp);
    document.getElementById('pp-p').innerText=fmt(pp);
    document.getElementById('pp-r1').innerText=fmt(r1);
    document.getElementById('pp-r2').innerText=fmt(r2);
    document.getElementById('pp-r3').innerText=fmt(r3);
    document.getElementById('pp-s1').innerText=fmt(s1);
    document.getElementById('pp-s2').innerText=fmt(s2);
    document.getElementById('pp-s3').innerText=fmt(s3);

    // â”€â”€ Scoring System (0-10)
    let score=0, maxScore=10;
    const isAboveMA99= cur>ma99;  if(isAboveMA99) score+=2;
    const isAboveMA25= cur>ma25;  if(isAboveMA25) score+=1.5;
    const isAboveMA7 = cur>ma7;   if(isAboveMA7)  score+=1;
    const macdBull   = macd>0;    if(macdBull)    score+=1.5;
    const rsiBull    = rsi14>50 && rsi14<75; if(rsiBull) score+=1;
    const bbBull     = cur > bb.mid; if(bbBull)   score+=1;
    const volBull    = curVol > avgVol*1.2; if(volBull&&macdBull) score+=1;
    const adxStrong  = adx > 25; if(adxStrong) score+=1;

    const scorePct = Math.round((score/maxScore)*100);

    // UI updates
    setScore('score-ma99', isAboveMA99, 'MA99 å¤š', 'MA99 ç©º');
    setScore('score-ma25', isAboveMA25, 'MA25 å¤š', 'MA25 ç©º');
    setScore('score-ma7',  isAboveMA7,  'MA7 å¤š',  'MA7 ç©º');

    const rsiLabel = rsi14>75?'è¶…è²·âš ï¸':rsi14<30?'è¶…è³£ğŸ”¥':(rsi14>55?'åå¤š':'åç©º');
    const rsiColor = rsi14>75?'red':rsi14<30?'green':rsi14>50?'green':'red';
    document.getElementById('score-rsi').innerHTML=`<span class="badge badge-${rsiColor=='green'?'bull':'bear'}">${rsi14.toFixed(1)} ${rsiLabel}</span>`;

    document.getElementById('score-macd').innerHTML=`<span class="badge ${macdBull?'badge-bull':'badge-bear'}">${macdBull?'å¤šé ­ â–²':'ç©ºé ­ â–¼'}</span>`;
    
    const bbPos = cur>bb.upper?'çªç ´ä¸Šè»Œâš ï¸':cur<bb.lower?'è·Œç ´ä¸‹è»ŒğŸ”¥':'é€šé“å…§';
    document.getElementById('score-bb').innerHTML=`<span class="badge badge-${cur>bb.upper?'bear':cur<bb.lower?'bull':'neu'}">${bbPos}</span>`;

    document.getElementById('atr-raw').innerText = fmt(atr14);
    document.getElementById('atr-pct').innerText = `${atrPct}%`;
    document.getElementById('atr-sl-price').innerText = fmt(cur - atr14*2.5);
    document.getElementById('adx-val').innerHTML = `<span class="badge ${adxStrong?'badge-blue':'badge-neu'}">${adx.toFixed(0)} ${adxStrong?'è¶¨å‹¢å¼·':'éœ‡ç›ª'}</span>`;
    document.getElementById('stochrsi-val').innerHTML = `<span class="badge ${stochK>80?'badge-bear':stochK<20?'badge-bull':'badge-neu'}">${stochK.toFixed(1)} ${stochK>80?'è¶…è²·':'è¶…è³£'}</span>`;

    // Volume
    document.getElementById('vol-status').innerHTML = `<span class="badge ${parseFloat(volRatio)>1.2?'badge-bull':'badge-neu'}">${volRatio}Ã— ${parseFloat(volRatio)>1.5?'æ”¾é‡':'æ­£å¸¸'}</span>`;

    // Range
    const rangeH = Math.max(...H.slice(-1)), rangeL = Math.min(...L.slice(-1));
    document.getElementById('range-24h').innerText = fmt(rangeH-rangeL);

    // Signal bar
    const bar = document.getElementById('signal-bar');
    bar.style.width = scorePct+'%';
    bar.style.background = scorePct>=70?'var(--green)':scorePct>=40?'var(--gold)':'var(--red)';
    document.getElementById('signal-val').innerText = scorePct+'%';

    // Trend display
    let trendHtml, overallBadge;
    if(score>=7){ trendHtml='<span class="badge badge-bull" style="font-size:1rem;">ğŸš€ å¼·å‹¢å¤šé ­</span>'; overallBadge='badge-bull'; }
    else if(score>=5){ trendHtml='<span class="badge badge-bull" style="font-size:1rem;">â†—ï¸ åå¤šéœ‡ç›ª</span>'; overallBadge='badge-blue'; }
    else if(score>=3){ trendHtml='<span class="badge badge-neu" style="font-size:1rem;">â†”ï¸ ä¸­æ€§ç›¤æ•´</span>'; overallBadge='badge-neu'; }
    else { trendHtml='<span class="badge badge-bear" style="font-size:1rem;">ğŸ» ç©ºé ­ä¿®æ­£</span>'; overallBadge='badge-bear'; }
    document.getElementById('trend-display').innerHTML = trendHtml;
    document.getElementById('overall-badge').className = 'badge '+overallBadge;
    document.getElementById('overall-badge').innerText = score>=7?'å¼·å¤š':score>=5?'åå¤š':score>=3?'ä¸­æ€§':'åç©º';

    // Pattern
    const body = Math.abs(cur - O[O.length-1]);
    const lowerShadow = Math.min(cur, O[O.length-1]) - L[L.length-1];
    const upperShadow = H[H.length-1] - Math.max(cur, O[O.length-1]);
    let pattern='ç„¡æ˜é¡¯å‹æ…‹';
    if(lowerShadow > body*2 && upperShadow < body*0.5) pattern='ğŸ”¨ éšé ­ç·š (è²·å…¥è¨Šè™Ÿ)';
    else if(upperShadow > body*2 && lowerShadow < body*0.5) pattern='ğŸŒŸ æµæ˜Ÿç·š (è³£å‡ºè¨Šè™Ÿ)';
    else if(body < (H[H.length-1]-L[L.length-1])*0.3) pattern='âœ¦ åå­—æ˜Ÿ (åè½‰è§€å¯Ÿ)';
    else if(cur > O[O.length-1] && body > atr14*1.5) pattern='ğŸ“ˆ å¼·å‹¢å¤§é™½ç·š';
    else if(cur < O[O.length-1] && body > atr14*1.5) pattern='ğŸ“‰ å¼·å‹¢å¤§é™°ç·š';
    document.getElementById('pattern-res').innerText = pattern;

    // Action text
    let action='';
    if(score>=7) action = rsi14>72 ? `âœ… å¼·å¤šç¢ºèªï¼Œä½†RSI ${rsi14.toFixed(0)} éç†±ã€‚\nå»ºè­°ï¼šåˆ†æ‰¹æ­¢ç›ˆï¼Œç­‰å¾…æ‹‰å›è‡³ MA25 (${fmt(ma25)}) å†åŠ ç¢¼ã€‚\né¢¨æ§ï¼šè·Œç ´ MA99 (${fmt(ma99)}) è¦–ç‚ºè­¦ç¤ºã€‚` : `ğŸš€ è¶¨å‹¢å®Œæ•´ï¼Œå‹•èƒ½å¥åº·ã€‚\nå»ºè­°ï¼šæ‹‰å› MA7/MA25 æ”¯æ’å€é–“è²·å…¥ã€‚\nçŸ­æœŸç›®æ¨™ï¼šR1 (${fmt(r1)})ï¼Œå¼·å‹¢å¯çœ‹ R2 (${fmt(r2)})ã€‚`;
    else if(score>=5) action = `â†—ï¸ çµæ§‹åå¤šï¼Œä½†å‹•èƒ½ä¸è¶³ã€‚\nå»ºè­°ï¼šç­‰å¾…çªç ´è¿‘æœŸé«˜é»ç¢ºèªå¾Œè¿½å…¥ï¼Œ\næˆ–åœ¨ S1 (${fmt(s1)}) é™„è¿‘ä½å¸ã€‚\næ­¢æè¨­ ATRæ­¢æ (${fmt(cur-atr14*2.5)})ã€‚`;
    else if(score>=3) action = `â†”ï¸ éœ‡ç›ªæ ¼å±€ï¼Œç„¡æ˜é¡¯æ–¹å‘ã€‚\nå»ºè­°ï¼šä½è²·é«˜è³£ï¼Œå€é–“æ“ä½œã€‚\næ”¯æ’ ${fmt(s1)}ï½${fmt(s2)}ï¼Œå£“åŠ› ${fmt(r1)}ï½${fmt(r2)}ã€‚`;
    else action = rsi14<30 ? `ğŸ”¥ ç©ºé ­ä½† RSI ${rsi14.toFixed(0)} æ·±åº¦è¶…è³£ï¼\nå»ºè­°ï¼šå¯æ¿€é€²è©¦å–®é€†å‹¢åå½ˆï¼Œåš´æ ¼è¨­å®šæ­¢æã€‚\nä¸­ç·šç­‰å¾…è¶¨å‹¢åè½‰è¨Šè™Ÿå†åšå¤šã€‚` : `ğŸ» ç©ºé ­æ’åˆ—ï¼Œæ‰€æœ‰æŒ‡æ¨™åç©ºã€‚\nå»ºè­°ï¼šè§€æœ›ç‚ºä¸»ï¼Œåš´ç¦åšå¤šã€‚\nç­‰å¾… RSI è·Œè‡³30ä»¥ä¸‹è¶…è³£å€æ¥åˆ€ã€‚`;
    document.getElementById('ai-action-text').innerText = action;
    document.getElementById('rec-buy').innerText = fmt(ma25);
    document.getElementById('rec-sell').innerText = fmt(r1);
    const rr = ((r1-ma25)/(ma25-(cur-atr14*2.5))).toFixed(2);
    document.getElementById('risk-reward').innerText = isFinite(rr)&&rr>0 ? '1 : '+rr : '---';

    // Indicators grid
    renderIndicatorsGrid({ cur, ma7, ma25, ma99, rsi14, macd, stochK, atr14, atrPct, adx, volRatio, bb });

  } catch(e){ console.error('quant err',e); }
}

function renderIndicatorsGrid(v){
  const cells = [
    { n:'RSI(14)',      val: v.rsi14.toFixed(1)+'%',  bull: v.rsi14>50&&v.rsi14<75, bear: v.rsi14>75||v.rsi14<30 },
    { n:'MACDæ–¹å‘',     val: v.macd>0?'å¤šé ­â–²':'ç©ºé ­â–¼', bull: v.macd>0, bear: v.macd<0 },
    { n:'MA7/MA25',     val: v.ma7>v.ma25?'é‡‘å‰':'æ­»å‰', bull: v.ma7>v.ma25, bear: v.ma7<v.ma25 },
    { n:'å¸ƒæ—ä½ç½®',     val: v.cur>v.bb.upper?'ä¸Šè»Œå¤–':v.cur<v.bb.lower?'ä¸‹è»Œå¤–':'é€šé“å…§', bull: v.cur<v.bb.lower, bear: v.cur>v.bb.upper },
    { n:'Stoch RSI',   val: v.stochK.toFixed(0)+'%', bull: v.stochK<20, bear: v.stochK>80 },
    { n:'ADXå¼·åº¦',     val: v.adx.toFixed(0), bull: v.adx>25, bear: v.adx<20 },
    { n:'ATR%æ³¢å‹•',    val: v.atrPct+'%', bull: parseFloat(v.atrPct)<3, bear: parseFloat(v.atrPct)>8 },
    { n:'æˆäº¤é‡',      val: v.volRatio+'Ã—', bull: parseFloat(v.volRatio)>1.2, bear: parseFloat(v.volRatio)<0.7 },
    { n:'å‡ç·šä¸Šæ–¹æ•¸', val: [v.cur>v.ma7,v.cur>v.ma25,v.cur>v.ma99].filter(Boolean).length+'/3', bull: v.cur>v.ma7&&v.cur>v.ma25&&v.cur>v.ma99 },
    { n:'å¸ƒæ—å¯¬åº¦',   val: fmt(v.bb.upper-v.bb.lower), bull: false },
    { n:'åé›¢MA25%',  val: ((v.cur-v.ma25)/v.ma25*100).toFixed(1)+'%', bull: (v.cur-v.ma25)/v.ma25>0 },
    { n:'åé›¢MA99%',  val: ((v.cur-v.ma99)/v.ma99*100).toFixed(1)+'%', bull: (v.cur-v.ma99)/v.ma99>0 },
  ];
  document.getElementById('indicators-grid').innerHTML = cells.map(c=>`
    <div class="ind-cell ${c.bull?'bull':c.bear?'bear':''}">
      <div class="ind-name">${c.n}</div>
      <div class="ind-val ${c.bull?'green':c.bear?'red':'gold'}">${c.val}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTI-TF MATRIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchMTFMatrix() {
  const tfs = ['15m','1h','4h','1d'];
  const results = await Promise.allSettled(tfs.map(async tf=>{
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${tf}&limit=100`);
    const d = await r.json();
    const C=d.map(k=>parseFloat(k[4]));
    const H=d.map(k=>parseFloat(k[2]));
    const L=d.map(k=>parseFloat(k[3]));
    const ma7=calcMA(C,7),ma25=calcMA(C,25),ma99=calcMA(C,Math.min(99,C.length));
    const rsi=calcRSI(C,14),macd=calcEMA(C,12)-calcEMA(C,26);
    const cur=C[C.length-1];
    let bull=0;
    if(cur>ma7) bull++; if(cur>ma25) bull++; if(cur>ma99) bull++;
    if(macd>0) bull++; if(rsi>50&&rsi<75) bull++;
    return { tf, bull, total:5 };
  }));
  const labels={'15m':'15m','1h':'1H','4h':'4H','1d':'1D'};
  let html='';
  results.forEach(r=>{
    if(r.status==='fulfilled'){
      const {tf,bull,total}=r.value;
      const pct=Math.round(bull/total*100);
      const cls=pct>=70?'green':pct>=40?'gold':'red';
      html+=`<div class="mtf-cell ${pct>=60?'bull':pct<40?'bear':''}">
        <div class="mtf-tf">${labels[tf]||tf}</div>
        <div class="mtf-val ${cls}">${bull}/${total}</div>
        <div style="font-size:0.65rem;color:var(--text-dim);margin-top:2px;">${pct>=70?'å¤šé ­':pct>=40?'ä¸­æ€§':'ç©ºé ­'}</div>
      </div>`;
    }
  });
  // Add combined
  document.getElementById('mtf-grid').innerHTML = html+
    `<div class="mtf-cell" style="border-color:var(--border-bright);grid-column:span 2;">
      <div class="mtf-tf">å¤šé€±æœŸå…±è­˜</div>
      <div class="mtf-val blue" id="mtf-consensus">---</div>
    </div>`;
  const scores = results.filter(r=>r.status==='fulfilled').map(r=>r.value.bull/r.value.total);
  const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
  document.getElementById('mtf-consensus').innerText = avg>=0.7?'å¼·å¤š ğŸš€':avg>=0.5?'åå¤š â†—ï¸':avg>=0.3?'ä¸­æ€§ â†”ï¸':'åç©º ğŸ»';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORDER BOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchOB() {
  try {
    const d = await (await fetch(`https://api.binance.com/api/v3/depth?symbol=${currentSymbol}&limit=20`)).json();
    const b=d.bids.reduce((a,v)=>a+parseFloat(v[1]),0);
    const s=d.asks.reduce((a,v)=>a+parseFloat(v[1]),0);
    const t=b+s;
    document.getElementById('ob-buy-bar').style.width=(b/t*100)+'%';
    document.getElementById('ob-sell-bar').style.width=(s/t*100)+'%';
    document.getElementById('ob-buy-pct').innerText=(b/t*100).toFixed(1)+'%';
    document.getElementById('ob-sell-pct').innerText=(s/t*100).toFixed(1)+'%';
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE PRICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchLivePrice() {
  try {
    const d = await (await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentSymbol}`)).json();
    const price = parseFloat(d.lastPrice);
    const change = parseFloat(d.priceChangePercent);
    document.getElementById('live-price').innerText = fmt(price);
    document.getElementById('price-change').innerHTML =
      `<span style="color:${change>=0?'var(--green)':'var(--red)'}; font-family:var(--mono); font-weight:700;">
        ${change>=0?'+':''}${change.toFixed(2)}%
      </span>
      <span style="color:var(--text-dim);font-size:0.75rem;margin-left:8px;">24H é«˜: ${fmt(parseFloat(d.highPrice))} ä½: ${fmt(parseFloat(d.lowPrice))}</span>`;
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUNDING RATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFunding() {
  if(fundingTimer) clearInterval(fundingTimer);
  try {
    const d = await (await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${currentSymbol}`)).json();
    const rate = parseFloat(d.lastFundingRate)*100;
    const el = document.getElementById('live-funding-rate');
    const st = document.getElementById('funding-status');
    el.innerText = rate.toFixed(4)+'%';
    if(rate>0.015){
      el.style.color='var(--red)'; st.style.background='var(--red-dim)'; st.style.borderColor='var(--red)'; st.style.color='var(--red)'; st.innerText='ğŸ”¥ æ¥µåº¦è²ªå©ª â€” èª˜å¤šç‡ƒæ–™';
    } else if(rate<0){
      el.style.color='var(--green)'; st.style.background='var(--green-dim)'; st.style.borderColor='var(--green)'; st.style.color='var(--green)'; st.innerText='ğŸ˜¨ è² è²»ç‡ â€” è»‹ç©ºç‡ƒæ–™';
    } else {
      el.style.color='var(--gold)'; st.style.background='var(--gold-dim)'; st.style.borderColor='var(--gold)'; st.style.color='var(--gold)'; st.innerText='âš–ï¸ æƒ…ç·’ä¸­æ€§';
    }
    const next = parseInt(d.nextFundingTime);
    fundingTimer = setInterval(()=>{
      const diff = next - Date.now();
      if(diff>0){
        const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
        document.getElementById('funding-countdown').innerText=`ä¸‹æ¬¡çµç®—: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      } else document.getElementById('funding-countdown').innerText='çµç®—ä¸­...';
    },1000);
    // History
    const hist = await (await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${currentSymbol}&limit=3`)).json();
    document.getElementById('funding-history').innerHTML = hist.reverse().map(d=>{
      const r=(parseFloat(d.fundingRate)*100).toFixed(4);
      const t=new Date(d.fundingTime).toLocaleString('zh-TW',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
      const c=parseFloat(r)>0.015?'var(--red)':parseFloat(r)<0?'var(--green)':'var(--gold)';
      return `<tr><td style="color:var(--text-dim);">${t}</td><td style="color:${c};font-weight:700;text-align:right;">${r}%</td></tr>`;
    }).join('');
  } catch(e){
    document.getElementById('live-funding-rate').innerText='N/A';
    document.getElementById('funding-status').innerText='ç„¡åˆç´„æ•¸æ“š';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcFib(interval, limit, btn) {
  if(btn){ document.querySelectorAll('.fib-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
  document.getElementById('fib-loading').style.display='inline';
  try {
    const binInterval = interval==='1w'?'1w':interval==='1d'?'1d':interval==='4h'?'4h':'1h';
    const data = await (await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${binInterval}&limit=${limit}`)).json();
    let max=-Infinity, min=Infinity;
    data.forEach(d=>{ if(parseFloat(d[2])>max) max=parseFloat(d[2]); if(parseFloat(d[3])<min) min=parseFloat(d[3]); });
    const cur=parseFloat(data[data.length-1][4]), diff=max-min;
    const levels=[
      {r:'1.000', p:max, t:'å‰é«˜ (High)', cls:'fib-sell'},
      {r:'0.786', p:max-diff*0.214, t:'å¼·å£“å›æ’¤ 0.786', cls:''},
      {r:'0.618', p:max-diff*0.382, t:'ğŸ… é»ƒé‡‘å£è¢‹ 0.618', cls:'fib-buy'},
      {r:'0.500', p:max-diff*0.5, t:'ä¸­è»¸ 0.5', cls:''},
      {r:'0.382', p:max-diff*0.618, t:'å¼±å‹¢åå½ˆ 0.382', cls:''},
      {r:'0.236', p:max-diff*0.764, t:'æ·ºå±¤æ”¯æ’ 0.236', cls:''},
      {r:'0.000', p:min, t:'å‰ä½ (Low)', cls:'fib-sell'},
      {r:'-0.236', p:min-diff*0.236, t:'å»¶ä¼¸æ”¯æ’ -0.236', cls:'fib-buy'},
      {r:'-0.618', p:min-diff*0.618, t:'æ·±åº¦ç›®æ¨™ -0.618', cls:'fib-buy'},
    ];
    let html='';
    levels.forEach(l=>{
      const distPct=((cur-l.p)/l.p*100).toFixed(2);
      const isNear=Math.abs(parseFloat(distPct))<1;
      const distCls=isNear?'fib-near':parseFloat(distPct)>0?'dist-pos':'dist-neg';
      // Level strength indicator
      const strength = l.r==='0.618'?'â˜…â˜…â˜…':l.r==='0.500'||l.r==='0.382'?'â˜…â˜…':l.r==='1.000'||l.r==='0.000'?'â˜…â˜…â˜…â˜…':'â˜…';
      html+=`<tr class="${l.cls} ${isNear?'dist-near':''}">
        <td>${l.r}</td>
        <td style="font-weight:700;color:#fff;">$${fmt(l.p)}</td>
        <td style="color:var(--text-dim);">${l.t}</td>
        <td class="${distCls}">${parseFloat(distPct)>=0?'+':''}${distPct}%</td>
        <td style="color:var(--gold);font-size:0.75rem;">${strength}</td>
      </tr>`;
    });
    document.getElementById('fib-body').innerHTML = html;
  } catch(e){}
  document.getElementById('fib-loading').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOTTOM SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateBottom(lbl, btn) {
  document.querySelectorAll('.gauge-pill').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  renderGauge(lbl); fetchScannerData(lbl);
}

function renderGauge(lbl) {
  const tvMap={'15m':'15','1h':'60','4h':'240','1D':'1D','1W':'1W','1M':'1M'};
  const tvCode = tvMap[lbl]||'1D';
  const c=document.getElementById('tv-gauge-bottom'); c.innerHTML='';
  setTimeout(()=>{
    const d=document.createElement('div'); d.className='tradingview-widget-container'; d.style.cssText='height:380px;width:100%;';
    d.innerHTML='<div class="tradingview-widget-container__widget" style="height:380px;width:100%;"></div>';
    const s=document.createElement('script'); s.src='https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js'; s.async=true;
    s.innerHTML=JSON.stringify({interval:tvCode,width:'100%',height:'380',isTransparent:true,symbol:'BINANCE:'+currentSymbol,showIntervalTabs:false,displayMode:'single',locale:'zh_TW',colorTheme:'dark'});
    d.appendChild(s); c.appendChild(d);
  },50);
}

async function fetchScannerData(lbl) {
  const loader=document.getElementById('bottom-loading');
  loader.style.display='inline';
  document.getElementById('scanner-rows').innerHTML='';
  const binMap={'15m':'15m','1h':'1h','4h':'4h','1D':'1d','1W':'1w','1M':'1M'};
  const binInterval=binMap[lbl]||'1d';
  try {
    const data=await (await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${binInterval}&limit=100`)).json();
    const C=data.map(d=>parseFloat(d[4]));
    const H=data.map(d=>parseFloat(d[2]));
    const L=data.map(d=>parseFloat(d[3]));
    const V=data.map(d=>parseFloat(d[5]));
    const cur=C[C.length-1];

    const rsi=calcRSI(C,14);
    const kd=calcKD(H,L,C,9,3,3);
    const sma20=calcMA(C,20),sma50=calcMA(C,50),sma200=calcMA(C,Math.min(200,C.length));
    const ema20=calcEMA(C,20),ema50=calcEMA(C,50);
    const macd=calcEMA(C,12)-calcEMA(C,26);
    const bb=calcBB(C,20,2);
    const mom=cur-C[C.length-11];
    const avgVol=V.slice(-20).reduce((a,b)=>a+b,0)/20;
    const adx=calcADX(H,L,C,14);
    const atr=calcATR(H,L,C,14);

    const rows=[
      {name:'RSI (14)',     val:rsi.toFixed(2), sig:rsi>70?'è¶…è²·':rsi<30?'è¶…è³£':'ä¸­æ€§', cls:rsi>70?'sig-s':rsi<30?'sig-b':'sig-n'},
      {name:'Stoch K (9)',  val:kd.k.toFixed(2)+'%', sig:kd.k>80?'è¶…è²·':kd.k<20?'è¶…è³£':'ä¸­æ€§', cls:kd.k>80?'sig-s':kd.k<20?'sig-b':'sig-n'},
      {name:'MACD',        val:macd.toFixed(4), sig:macd>0?'å¤šé ­':'ç©ºé ­', cls:macd>0?'sig-b':'sig-s'},
      {name:'SMA 20',      val:fmt(sma20), sig:cur>sma20?'å¤š':'ç©º', cls:cur>sma20?'sig-b':'sig-s'},
      {name:'SMA 50',      val:fmt(sma50), sig:cur>sma50?'å¤š':'ç©º', cls:cur>sma50?'sig-b':'sig-s'},
      {name:'SMA 200',     val:fmt(sma200), sig:cur>sma200?'å¤š':'ç©º', cls:cur>sma200?'sig-b':'sig-s'},
      {name:'EMA 20',      val:fmt(ema20), sig:cur>ema20?'å¤š':'ç©º', cls:cur>ema20?'sig-b':'sig-s'},
      {name:'EMA 50',      val:fmt(ema50), sig:cur>ema50?'å¤š':'ç©º', cls:cur>ema50?'sig-b':'sig-s'},
      {name:'å¸ƒæ—ä¸Šè»Œ',    val:fmt(bb.upper), sig:cur>bb.upper?'è¶…è²·':'æ­£å¸¸', cls:cur>bb.upper?'sig-s':'sig-n'},
      {name:'å¸ƒæ—ä¸‹è»Œ',    val:fmt(bb.lower), sig:cur<bb.lower?'è¶…è³£':'æ­£å¸¸', cls:cur<bb.lower?'sig-b':'sig-n'},
      {name:'ADX',         val:adx.toFixed(1), sig:adx>25?'è¶¨å‹¢å¼·':'éœ‡ç›ª', cls:adx>25?'sig-b':'sig-n'},
      {name:'ATR (14)',    val:fmt(atr), sig:'-', cls:'sig-n'},
      {name:'æˆäº¤é‡æ¯”ä¾‹', val:(V[V.length-1]/avgVol).toFixed(2)+'Ã—', sig:V[V.length-1]>avgVol*1.5?'æ”¾é‡':V[V.length-1]<avgVol*0.7?'ç¸®é‡':'æ­£å¸¸', cls:V[V.length-1]>avgVol*1.5?'sig-b':'sig-n'},
      {name:'å‹•èƒ½ (10)',  val:mom>0?'+'+mom.toFixed(2):mom.toFixed(2), sig:mom>0?'æ­£å‘':'è² å‘', cls:mom>0?'sig-b':'sig-s'},
    ];
    document.getElementById('scanner-rows').innerHTML = rows.map(r=>
      `<tr><td>${r.name}</td><td style="font-family:var(--mono);">${r.val}</td><td><span class="${r.cls}">${r.sig}</span></td></tr>`
    ).join('');
  } catch(e){}
  loader.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATH UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){ if(!n&&n!==0)return'---'; if(n>10000)return n.toFixed(2); if(n>100)return n.toFixed(3); if(n>1)return n.toFixed(4); if(n<0.0001)return n.toFixed(8); return n.toFixed(6); }
function calcMA(d,p){ if(d.length<p)return 0; return d.slice(-p).reduce((a,b)=>a+b,0)/p; }
function calcEMA(d,p){ const k=2/(p+1); let ema=d[0]; for(let i=1;i<d.length;i++) ema=d[i]*k+ema*(1-k); return ema; }
function calcRSI(c,p){ let g=0,l=0; for(let i=c.length-p-1;i<c.length-1;i++){ const d=c[i+1]-c[i]; d>0?g+=d:l-=d; } const rs=(g/p)/(l/p||0.0001); return 100-(100/(1+rs)); }
function calcATR(h,l,c,p){ let s=0; for(let i=1;i<=p;i++){ const idx=h.length-i; s+=Math.max(h[idx]-l[idx],Math.abs(h[idx]-c[idx-1]),Math.abs(l[idx]-c[idx-1])); } return s/p; }
function calcKD(h,l,c,p){ const lo=Math.min(...l.slice(-p)),hi=Math.max(...h.slice(-p)),cl=c[c.length-1]; const rsv=(cl-lo)/(hi-lo||1)*100; return {k:rsv,d:rsv}; }
function calcBB(d,p,mult){ const ma=calcMA(d,p); const std=Math.sqrt(d.slice(-p).reduce((a,b)=>a+(b-ma)**2,0)/p); return {upper:ma+std*mult,mid:ma,lower:ma-std*mult}; }
function calcStochRSI(c,p,smooth){ const rsis=[]; for(let i=p;i<c.length;i++) rsis.push(calcRSI(c.slice(0,i+1),p)); const lo=Math.min(...rsis.slice(-p)),hi=Math.max(...rsis.slice(-p)); const cur=rsis[rsis.length-1]; return (cur-lo)/(hi-lo||1)*100; }
function calcADX(h,l,c,p){
  let dmPlus=[],dmMinus=[],tr=[];
  for(let i=1;i<h.length;i++){
    const up=h[i]-h[i-1],dn=l[i-1]-l[i];
    dmPlus.push(up>dn&&up>0?up:0);
    dmMinus.push(dn>up&&dn>0?dn:0);
    tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));
  }
  const atr14=tr.slice(-p).reduce((a,b)=>a+b,0)/p;
  const pdi=(dmPlus.slice(-p).reduce((a,b)=>a+b,0)/p)/(atr14||1)*100;
  const mdi=(dmMinus.slice(-p).reduce((a,b)=>a+b,0)/p)/(atr14||1)*100;
  const dx=Math.abs(pdi-mdi)/(pdi+mdi||1)*100;
  return dx;
}
function setScore(id, pass, txtP, txtF){
  document.getElementById(id).innerHTML = pass
    ? `<span class="badge badge-bull">${txtP}</span>`
    : `<span class="badge badge-bear">${txtF}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize gauge and bottom scanner
setTimeout(()=>{ renderGauge('4h'); fetchScannerData('4h'); }, 500);
</script>
</body>
</html>
