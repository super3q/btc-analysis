<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto AI Quant Analyst (v5.2 Tactical)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root { --bg-dark: #0b0e11; --card-bg: #1e2329; --card-border: #2b3139; --primary: #0575e6; --accent: #00f260; --text-main: #eaecef; --text-dim: #848e9c; --green: #0ECB81; --red: #F6465D; --gold: #F0B90B; }
        body { font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* Header & Search */
        .header-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        h1 { background: linear-gradient(to right, var(--accent), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 10px 0; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; font-size: 2rem; text-align: center; }
        .search-box { display: flex; gap: 10px; background: var(--card-bg); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(5, 117, 230, 0.2); width: 100%; max-width: 400px; }
        .search-input { background: transparent; border: none; color: #fff; flex-grow: 1; outline: none; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .search-btn { background: var(--primary); color: #fff; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        /* Controls */
        .control-bar { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-coin, .btn-tf, .btn-fib { background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text-dim); padding: 6px 14px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-coin:hover, .btn-tf:hover, .btn-fib:hover { border-color: var(--primary); color: #fff; }
        .btn-coin.active, .btn-tf.active, .btn-fib.active { background: var(--card-border); color: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* Grid Layout */
        .grid-main { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-fib { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }

        @media (max-width: 1400px) { .grid-dashboard, .grid-fib { grid-template-columns: 1fr; } }
        @media (max-width: 1000px) { .grid-main { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--card-border); padding: 20px; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.1rem; color: #fff; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        /* Analysis Modules */
        .signal-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #555; }
        .signal-bull { border-left-color: var(--green); background: linear-gradient(90deg, rgba(14,203,129,0.1), transparent); }
        .signal-bear { border-left-color: var(--red); background: linear-gradient(90deg, rgba(246,70,93,0.1), transparent); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .stat-val { font-family: 'Roboto Mono', monospace; font-weight: bold; }
        
        /* Fib Styles */
        .fib-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 15px; }
        .fib-table th { text-align: left; color: #888; padding: 8px; border-bottom: 1px solid #444; }
        .fib-table td { padding: 10px 8px; border-bottom: 1px solid #333; }
        .fib-row-highlight { background: rgba(240, 185, 11, 0.1); border-left: 3px solid var(--gold); }
        
        /* Strategy Board */
        .strategy-card { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .strategy-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; }
        .price-tag { font-family: 'Roboto Mono', monospace; font-weight: bold; font-size: 1.1rem; }
        
        /* Helpers */
        .text-green { color: var(--green); } .text-red { color: var(--red); } .text-gold { color: #F0B90B; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-green { background: rgba(14,203,129,0.2); color: var(--green); }
        .tag-red { background: rgba(246,70,93,0.2); color: var(--red); }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--accent), var(--primary)); z-index: 9999; display: none; }
        
        /* Order Book */
        .ob-container { height: 24px; background: #333; border-radius: 4px; display: flex; overflow: hidden; margin-top: 5px; }
        .ob-fill-buy { background: var(--green); height: 100%; display: flex; align-items: center; padding-left: 5px; color: #000; font-size: 11px; font-weight: bold; transition: width 0.5s; }
        .ob-fill-sell { background: var(--red); height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; color: #fff; font-size: 11px; font-weight: bold; transition: width 0.5s; }
    </style>
</head>
<body>

<div id="loading"></div>

<div class="container">
    <div class="header-section">
        <h1>Crypto AI Quant Analyst <span style="font-size:0.4em; color:var(--text-dim); vertical-align: middle; border:1px solid #333; padding:2px 6px; border-radius:4px;">v5.2 TACTICAL</span></h1>
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" id="symbolInput" class="search-input" value="BTC" onkeypress="if(event.key==='Enter') loadNewSymbol()">
            <button class="search-btn" onclick="loadNewSymbol()">GO</button>
        </div>
        <div class="control-bar" style="margin-top:15px;">
            <button class="btn-coin active" onclick="quickLoad('BTC')">BTC</button>
            <button class="btn-coin" onclick="quickLoad('ETH')">ETH</button>
            <button class="btn-coin" onclick="quickLoad('SOL')">SOL</button>
            <button class="btn-coin" onclick="quickLoad('DOGE')">DOGE</button>
            <button class="btn-coin" onclick="quickLoad('BNB')">BNB</button>
            <span style="width:20px;"></span>
            <button class="btn-tf" onclick="changeTf('15m')">15m</button>
            <button class="btn-tf" onclick="changeTf('1h')">1H</button>
            <button class="btn-tf active" onclick="changeTf('4h')">4H</button>
            <button class="btn-tf" onclick="changeTf('1d')">1D</button>
        </div>
    </div>

    <div class="grid-main">
        <div class="card" style="height: 650px; padding:0;">
             <div class="tradingview-widget-container" id="tv-chart" style="height:100%;width:100%"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ å¸‚å ´æ·±åº¦ & ç±Œç¢¼ (Order Flow)</span>
            </div>
            <div style="flex-grow: 1; display:flex; flex-direction: column; gap: 20px;">
                <div>
                    <div class="stat-row">
                        <span>è²·æ–¹æ›å–® (Bids)</span>
                        <span id="bid-pct" class="text-green">--%</span>
                    </div>
                    <div class="ob-container">
                        <div id="ob-bid-bar" class="ob-fill-buy" style="width:50%"></div>
                        <div id="ob-ask-bar" class="ob-fill-sell" style="width:50%"></div>
                    </div>
                    <div class="stat-row" style="margin-top:5px;">
                        <span id="ask-pct" class="text-red">--%</span>
                        <span>è³£æ–¹æ›å–® (Asks)</span>
                    </div>
                </div>

                <div>
                    <div class="card-title" style="font-size: 0.9rem; margin-bottom:10px;">ğŸ¯ æ©Ÿæ§‹æ¨è»¸é» (Pivot Points)</div>
                    <table class="fib-table" style="margin-top:0;">
                        <tr><td class="text-red">R2 (å£“åŠ›)</td><td id="p-r2">---</td></tr>
                        <tr><td class="text-red">R1 (å£“åŠ›)</td><td id="p-r1">---</td></tr>
                        <tr><td class="text-gold">Pivot (ä¸­è»¸)</td><td id="p-p">---</td></tr>
                        <tr><td class="text-green">S1 (æ”¯æ’)</td><td id="p-s1">---</td></tr>
                        <tr><td class="text-green">S2 (æ”¯æ’)</td><td id="p-s2">---</td></tr>
                    </table>
                </div>

                <div id="volatility-box" class="signal-box">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸŒ‹ æ³¢å‹•ç‡ç›£æ§ (BBW)</div>
                    <div class="stat-row">
                        <span>ç•¶å‰å¯¬åº¦:</span>
                        <span id="bbw-val" class="stat-val">---</span>
                    </div>
                    <div id="bbw-msg" style="font-size:0.8rem; color:var(--text-dim); line-height:1.4;">è¨ˆç®—ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-dashboard">
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ§  AI è¶¨å‹¢è§£ç¢¼ (MACD/ADX)</span>
                <span id="ai-score" class="tag" style="font-size:1rem;">N/A</span>
            </div>
            
            <div class="signal-box" id="main-signal-box">
                <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-dim);">ä¸»è¦ç­–ç•¥å»ºè­°</div>
                <div id="ai-strategy" style="font-size:1.1rem; font-weight:bold; margin-top:5px;">æ•¸æ“šè¼‰å…¥ä¸­...</div>
            </div>

            <div class="stat-row">
                <span>MACD (12,26,9)</span>
                <span id="val-macd" class="stat-val">---</span>
            </div>
            <div class="stat-row">
                <span>ADX è¶¨å‹¢å¼·åº¦ (14)</span>
                <span id="val-adx" class="stat-val">---</span>
            </div>
            <div class="stat-row">
                <span>RSI å‹•èƒ½ (14)</span>
                <span id="val-rsi" class="stat-val">---</span>
            </div>
            <div class="stat-row">
                <span>ATR çœŸå¯¦æ³¢å¹…</span>
                <span id="val-atr" class="stat-val">---</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸŒ å¤šé€±æœŸå…±æŒ¯é›·é”</span>
            </div>
            <table class="fib-table" style="margin-top:0;">
                <thead>
                    <tr>
                        <th>é€±æœŸ</th>
                        <th>EMA (25)</th>
                        <th>RSI</th>
                        <th>ä¿¡è™Ÿ</th>
                    </tr>
                </thead>
                <tbody id="matrix-body">
                    <tr><td colspan="4">æƒæä¸­...</td></tr>
                </tbody>
            </table>
            <div style="margin-top:15px; font-size:0.8rem; color:var(--text-dim);">
                * å…¨ç¶ ï¼šå¼·åŠ›è²·é€² (Strong Buy)<br>
                * å…¨ç´…ï¼šå¼·åŠ›è³£å‡º (Strong Sell)
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ”¬ é¢¨æ§èˆ‡å½¢æ…‹</span>
            </div>
            <div class="stat-row">
                <span>Kç·šå‹æ…‹:</span>
                <span id="pattern-res" class="text-gold" style="font-weight:bold;">ç„¡</span>
            </div>
            <div class="stat-row">
                <span>å»ºè­°å‹•æ…‹æ­¢æ:</span>
                <span id="rec-sl" class="text-red stat-val">---</span>
            </div>
            
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">è³‡é‡‘æµå‘ (Money Flow)</div>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                    {
                    "symbol": "BINANCE:BTCUSDT",
                    "width": "100%",
                    "height": 180,
                    "locale": "zh_TW",
                    "dateRange": "12M",
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "autosize": false,
                    "largeChartUrl": ""
                    }
                    </script>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
            <span class="card-title">ğŸ“ æ–æ³¢ç´å¥‘æˆ°è¡“æŒ‡æ®æ¿ (Tactical Fib)</span>
            <div class="control-bar" style="margin:0;">
                <button class="btn-fib" onclick="updateFib('1h', 24, this)">4H (ç•¶æ²–)</button>
                <button class="btn-fib" onclick="updateFib('4h', 30, this)">1D (éš”å¤œ)</button>
                <button class="btn-fib" onclick="updateFib('1d', 7, this)">1W (é€±ç·š)</button>
                <button class="btn-fib active" onclick="updateFib('1d', 30, this)">1M (æœˆç·š)</button>
                <button class="btn-fib" onclick="updateFib('1d', 180, this)">åŠå¹´</button>
            </div>
        </div>
        <div class="grid-fib">
            <div>
                <table class="fib-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>åƒ¹æ ¼</th>
                            <th>èªªæ˜</th>
                            <th>å·®è·</th>
                        </tr>
                    </thead>
                    <tbody id="fib-body"></tbody>
                </table>
            </div>
            
            <div class="strategy-card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
                    <span style="font-weight:bold; color:#fff;">ğŸ›¡ï¸ æ™ºèƒ½äº¤æ˜“æ±ºç­– (AI Setup)</span>
                    <span id="fib-trend-label" class="tag">è¨ˆç®—ä¸­...</span>
                </div>
                
                <div class="strategy-row" style="border-left: 3px solid var(--green);">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-dim);">ğŸŸ¢ å»ºè­°å¤šå–®é€²å ´ (Buy Zone)</div>
                        <div style="font-size:0.75rem; color:#666;">å›è¸©æ”¯æ’ç¢ºèªå¾Œé€²å ´</div>
                    </div>
                    <div id="setup-buy" class="price-tag text-green">---</div>
                </div>

                <div class="strategy-row" style="border-left: 3px solid var(--red);">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-dim);">ğŸ”´ å»ºè­°ç©ºå–®é€²å ´ (Sell Zone)</div>
                        <div style="font-size:0.75rem; color:#666;">åå½ˆå£“åŠ›ä¸éæ™‚é€²å ´</div>
                    </div>
                    <div id="setup-sell" class="price-tag text-red">---</div>
                </div>

                <div class="strategy-row" style="border-left: 3px solid var(--gold);">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-dim);">âš ï¸ é¢¨æ§æ­¢æ (Stop Loss)</div>
                        <div style="font-size:0.75rem; color:#666;">è·Œç ´/çªç ´é—œéµä½å‡ºå ´</div>
                    </div>
                    <div id="setup-sl" class="price-tag text-gold">---</div>
                </div>
                
                <div id="fib-comment" style="font-size:0.9rem; color:#ccc; line-height:1.5; margin-top:10px;">
                    è«‹é¸æ“‡ä¸Šæ–¹æ™‚é–“é€±æœŸä»¥è¼‰å…¥æ•¸æ“š...
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Configuration ---
    let state = {
        symbol: 'BTCUSDT',
        coin: 'BTC',
        tf: '4h', 
        binanceInterval: '4h',
        currentPrice: 0,
        trend: 'neutral'
    };

    const tfMap = {
        '15m': { bin: '15m', tv: '15' },
        '1h':  { bin: '1h',  tv: '60' },
        '4h':  { bin: '4h',  tv: '240' },
        '1d':  { bin: '1d',  tv: 'D' }
    };

    // --- Initialization ---
    window.onload = function() {
        loadChart();
        refreshData();
        // Init Fib with Monthly view
        setTimeout(() => updateFib('1d', 30, document.querySelectorAll('.btn-fib')[3]), 1000);
        setInterval(refreshData, 60000); 
    };

    function quickLoad(coin) {
        document.querySelectorAll('.btn-coin').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        state.coin = coin;
        state.symbol = coin + 'USDT';
        document.getElementById('symbolInput').value = coin;
        loadChart();
        refreshData();
        updateFib('1d', 30, document.querySelectorAll('.btn-fib')[3]);
    }

    function loadNewSymbol() {
        let val = document.getElementById('symbolInput').value.toUpperCase();
        if(!val) return;
        state.coin = val;
        state.symbol = val.endsWith('USDT') ? val : val + 'USDT';
        loadChart();
        refreshData();
        updateFib('1d', 30, document.querySelectorAll('.btn-fib')[3]);
    }

    function changeTf(tf) {
        document.querySelectorAll('.btn-tf').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        state.tf = tf;
        state.binanceInterval = tfMap[tf].bin;
        loadChart(); 
        refreshData();
    }

    // --- TradingView Chart ---
    function loadChart() {
        const container = document.getElementById('tv-chart');
        container.innerHTML = ''; 
        const div = document.createElement('div');
        div.className = 'tradingview-widget-container__widget';
        div.style.height = '100%';
        div.style.width = '100%';
        container.appendChild(div);

        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
        script.async = true;
        script.innerHTML = JSON.stringify({
            "autosize": true,
            "symbol": "BINANCE:" + state.symbol,
            "interval": tfMap[state.tf].tv,
            "timezone": "Asia/Taipei",
            "theme": "dark",
            "style": "1",
            "locale": "zh_TW",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "studies": [
                "MASimple@tv-basicstudies",
                "MACD@tv-basicstudies", 
                "BB@tv-basicstudies", 
                "AverageDirectionalIndex@tv-basicstudies"
            ],
            "support_host": "https://www.tradingview.com"
        });
        container.appendChild(script);
    }

    // --- Data Fetching & Quant Logic ---
    async function refreshData() {
        document.getElementById('loading').style.display = 'block';
        try {
            fetchOrderBook();
            await runMainAnalysis();
            await runMatrixScan();
        } catch (e) { console.error(e); }
        document.getElementById('loading').style.display = 'none';
    }

    async function fetchOrderBook() {
        const res = await fetch(`https://api.binance.com/api/v3/depth?symbol=${state.symbol}&limit=20`);
        const data = await res.json();
        let bids = data.bids.reduce((a, b) => a + parseFloat(b[1]), 0);
        let asks = data.asks.reduce((a, b) => a + parseFloat(b[1]), 0);
        let total = bids + asks;
        let bidPct = (bids / total) * 100;
        let askPct = (asks / total) * 100;
        document.getElementById('bid-pct').innerText = bidPct.toFixed(1) + "%";
        document.getElementById('ask-pct').innerText = askPct.toFixed(1) + "%";
        document.getElementById('ob-bid-bar').style.width = bidPct + "%";
        document.getElementById('ob-ask-bar').style.width = askPct + "%";
    }

    async function runMainAnalysis() {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${state.symbol}&interval=${state.binanceInterval}&limit=200`);
        const raw = await res.json();
        
        let closes = raw.map(x => parseFloat(x[4]));
        let highs = raw.map(x => parseFloat(x[2]));
        let lows = raw.map(x => parseFloat(x[3]));
        state.currentPrice = closes[closes.length - 1];

        // Indicators
        let rsi = calcRSI(closes, 14);
        let adx = calcADX(highs, lows, closes, 14);
        let atr = calcATR(highs, lows, closes, 14);
        let bb = calcBB(closes, 20, 2);
        let ma25 = calcSMA(closes, 25);
        let ma99 = calcSMA(closes, 99);
        let macd = calcMACD(closes, 12, 26, 9);
        
        state.trend = state.currentPrice > ma25 ? 'bull' : 'bear'; // Global trend state

        // UI Updates
        document.getElementById('val-rsi').innerHTML = formatRSI(rsi);
        document.getElementById('val-adx').innerHTML = formatADX(adx.adx);
        document.getElementById('val-atr').innerText = atr.toFixed(2);
        document.getElementById('val-macd').innerHTML = formatMACD(macd);

        // BBW
        let bbw = (bb.upper - bb.lower) / bb.middle;
        document.getElementById('bbw-val').innerText = bbw.toFixed(4);
        let bbwMsg = document.getElementById('bbw-msg');
        if (bbw < 0.05) bbwMsg.innerHTML = "<span class='text-gold'>âš ï¸ Squeeze Alert!</span> æº–å‚™è®Šç›¤";
        else bbwMsg.innerText = "æ³¢å‹•ç‡æ­£å¸¸";

        // Pivots
        let prevH = highs[highs.length-2], prevL = lows[lows.length-2], prevC = closes[closes.length-2];
        let pp = (prevH + prevL + prevC) / 3;
        document.getElementById('p-p').innerText = pp.toFixed(2);
        document.getElementById('p-r1').innerText = (2 * pp - prevL).toFixed(2);
        document.getElementById('p-r2').innerText = (pp + (prevH - prevL)).toFixed(2);
        document.getElementById('p-s1').innerText = (2 * pp - prevH).toFixed(2);
        document.getElementById('p-s2').innerText = (pp - (prevH - prevL)).toFixed(2);

        // Main Strategy
        let strategyBox = document.getElementById('main-signal-box');
        let strategyText = document.getElementById('ai-strategy');
        let scoreTag = document.getElementById('ai-score');
        let patternText = document.getElementById('pattern-res');
        document.getElementById('rec-sl').innerText = (state.currentPrice - (2 * atr)).toFixed(2);

        // Pattern
        let open = parseFloat(raw[raw.length-1][1]), close = state.currentPrice;
        let body = Math.abs(close - open);
        if ((Math.min(close, open) - lows[lows.length-1]) > body * 2) patternText.innerText = "ğŸ”¨ éŒ˜é ­ (Hammer)";
        else if ((highs[highs.length-1] - Math.max(close, open)) > body * 2) patternText.innerText = "â˜„ï¸ æµæ˜Ÿ (Shooting Star)";
        else patternText.innerText = "---";

        // Trend Logic
        let trendScore = 0;
        if (state.currentPrice > ma25) trendScore++;
        if (state.currentPrice > ma99) trendScore++;
        if (adx.adx > 25 && adx.pdi > adx.mdi) trendScore++; 
        if (macd.histogram > 0) trendScore++;

        strategyBox.className = 'signal-box'; 
        if (adx.adx < 20) {
            strategyText.innerHTML = "ğŸ’¤ ç›¤æ•´éœ‡ç›ª (Range)<br><span style='font-size:0.9rem; font-weight:normal'>RSI é«˜æ‹‹ä½å¸ï¼Œå‹¿è¿½åƒ¹ã€‚</span>";
            scoreTag.innerText = "ä¸­æ€§"; scoreTag.className = "tag";
        } else {
            if (trendScore >= 3) {
                strategyBox.classList.add('signal-bull');
                strategyText.innerHTML = "ğŸš€ å¼·åŠ›å¤šé ­ (Strong Bull)<br><span style='font-size:0.9rem; font-weight:normal'>å›èª¿æ‰¾è²·é»ï¼Œé †å‹¢æ“ä½œã€‚</span>";
                scoreTag.innerText = "å¼·å¤š"; scoreTag.className = "tag tag-green";
            } else if (trendScore <= 1 && state.currentPrice < ma25) { 
                 strategyBox.classList.add('signal-bear');
                 strategyText.innerHTML = "ğŸ» ç©ºé ­èµ°å‹¢ (Bearish)<br><span style='font-size:0.9rem; font-weight:normal'>åå½ˆä¸éå£“åŠ›åšç©ºã€‚</span>";
                 scoreTag.innerText = "åç©º"; scoreTag.className = "tag tag-red";
            } else {
                 strategyText.innerHTML = "âš–ï¸ æ–¹å‘ä¸æ˜ (Uncertain)<br><span style='font-size:0.9rem; font-weight:normal'>è¨Šè™Ÿè¡çªï¼Œå»ºè­°è§€æœ›ã€‚</span>";
                 scoreTag.innerText = "è§€å¯Ÿ"; scoreTag.className = "tag";
            }
        }
    }

    async function runMatrixScan() {
        const tfs = ['15m', '1h', '4h', '1d'];
        let html = '';
        for (let t of tfs) {
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${state.symbol}&interval=${t}&limit=50`);
            const raw = await res.json();
            let c = raw.map(x => parseFloat(x[4]));
            let cur = c[c.length-1];
            let ema25 = calcEMA(c, 25);
            let rsi = calcRSI(c, 14);
            let trend = cur > ema25 ? 'bull' : 'bear';
            let trendColor = trend === 'bull' ? 'text-green' : 'text-red';
            let rsiClass = rsi > 70 ? 'tag-red' : (rsi < 30 ? 'tag-green' : '');
            let sig = (trend === 'bull' && rsi < 70) ? 'Buy' : ((trend === 'bear' && rsi > 30) ? 'Sell' : 'Wait');
            
            html += `<tr><td>${t.toUpperCase()}</td><td class="${trendColor}">${ema25.toFixed(2)}</td><td><span class="tag ${rsiClass}">${rsi.toFixed(0)}</span></td><td>${sig}</td></tr>`;
        }
        document.getElementById('matrix-body').innerHTML = html;
    }

    // --- Fib PRO Logic (Tactical Update) ---
    async function updateFib(interval, limit, btn) {
        if(btn) { document.querySelectorAll('.btn-fib').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        document.getElementById('fib-body').innerHTML = '<tr><td colspan="4">è¨ˆç®—ä¸­...</td></tr>';
        
        // Fetch specific range logic
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${state.symbol}&interval=${interval}&limit=${limit}`);
        const data = await res.json();
        let max = -Infinity, min = Infinity;
        data.forEach(d => { 
            let h = parseFloat(d[2]), l = parseFloat(d[3]);
            if(h>max) max=h; if(l<min) min=l; 
        });
        
        const diff = max - min;
        const levels = [
            { lvl: 1.0, name: "é«˜é» (High)", price: max },
            { lvl: 0.786, name: "Fib 0.786", price: min + diff * 0.786 },
            { lvl: 0.618, name: "é»ƒé‡‘ä½ (Golden)", price: min + diff * 0.618 },
            { lvl: 0.5, name: "ä¸­è»¸ (0.5)", price: min + diff * 0.5 },
            { lvl: 0.382, name: "Fib 0.382", price: min + diff * 0.382 },
            { lvl: 0.236, name: "Fib 0.236", price: min + diff * 0.236 },
            { lvl: 0.0, name: "ä½é» (Low)", price: min }
        ];

        // 1. Render Table
        let html = '';
        let closestDist = Infinity;
        let nearestRes = max;
        let nearestSup = min;

        // Find nearest levels
        levels.forEach(l => {
            let distPct = ((state.currentPrice - l.price) / l.price) * 100;
            let absDist = Math.abs(distPct);
            if(absDist < closestDist) closestDist = absDist;
            
            // Logic for Sup/Res
            if(l.price > state.currentPrice && l.price < nearestRes) nearestRes = l.price;
            if(l.price < state.currentPrice && l.price > nearestSup) nearestSup = l.price;

            let colorClass = absDist < 0.5 ? 'fib-row-highlight text-gold' : '';
            html += `<tr class="${colorClass}">
                <td>${l.lvl}</td><td style="font-family:'Roboto Mono'">${l.price.toFixed(2)}</td><td>${l.name}</td><td>${distPct > 0 ? '+' : ''}${distPct.toFixed(2)}%</td>
            </tr>`;
        });
        document.getElementById('fib-body').innerHTML = html;

        // 2. Tactical Board Logic
        const cp = state.currentPrice;
        const isBull = state.trend === 'bull';
        
        // Setup Logic
        let buyPrice = nearestSup; 
        let sellPrice = nearestRes;
        let slPrice = isBull ? nearestSup * 0.99 : nearestRes * 1.01; // Dynamic SL

        document.getElementById('setup-buy').innerText = buyPrice.toFixed(2);
        document.getElementById('setup-sell').innerText = sellPrice.toFixed(2);
        document.getElementById('setup-sl').innerText = slPrice.toFixed(2);

        // Trend Label
        let tLabel = document.getElementById('fib-trend-label');
        if(isBull) { tLabel.innerText = "å¤šé ­æ¶æ§‹ (Bull)"; tLabel.className="tag tag-green"; }
        else { tLabel.innerText = "ç©ºé ­æ¶æ§‹ (Bear)"; tLabel.className="tag tag-red"; }

        // AI Comment
        let comment = `åƒ¹æ ¼ä½æ–¼ <strong>${nearestSup.toFixed(2)}</strong> (æ”¯æ’) èˆ‡ <strong>${nearestRes.toFixed(2)}</strong> (å£“åŠ›) ä¹‹é–“ã€‚<br>`;
        if(isBull) comment += `è¶¨å‹¢åå¤šï¼Œå»ºè­°åœ¨å›æ¸¬æ”¯æ’ä½ <strong>${buyPrice.toFixed(2)}</strong> æ™‚åˆ†æ‰¹ä½ˆå±€å¤šå–®ï¼Œè·Œç ´æ­¢æã€‚`;
        else comment += `è¶¨å‹¢åç©ºï¼Œå»ºè­°åœ¨åå½ˆå£“åŠ›ä½ <strong>${sellPrice.toFixed(2)}</strong> æ™‚ä½ˆå±€ç©ºå–®ï¼Œçªç ´æ­¢æã€‚`;
        
        document.getElementById('fib-comment').innerHTML = comment;
    }

    // --- Math Helpers ---
    function calcSMA(data, window) { if(data.length < window) return 0; return data.slice(-window).reduce((a,b)=>a+b,0)/window; }
    function calcEMA(data, window) {
        let k = 2 / (window + 1);
        let ema = data[0];
        for (let i = 1; i < data.length; i++) ema = data[i] * k + ema * (1 - k);
        return ema;
    }
    function calcRSI(c, p) {
        let gains=0, losses=0;
        for (let i=c.length-p-1; i<c.length-1; i++) { let diff=c[i+1]-c[i]; if(diff>0) gains+=diff; else losses-=diff; }
        return 100 - (100 / (1 + (gains/losses)));
    }
    function calcATR(h, l, c, p) {
        let trs=[]; for(let i=1; i<h.length; i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
        return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
    }
    function calcBB(c, p, mult) {
        let sma = calcSMA(c, p);
        let sumSq = c.slice(-p).reduce((a,b)=>a+Math.pow(b-sma,2),0);
        let std = Math.sqrt(sumSq/p);
        return { middle: sma, upper: sma+(std*mult), lower: sma-(std*mult) };
    }
    function calcADX(h, l, c, p) {
        let tr=[], dmP=[], dmM=[];
        for(let i=1; i<h.length; i++) {
            tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            let up=h[i]-h[i-1], down=l[i-1]-l[i];
            dmP.push(up>down && up>0 ? up:0); dmM.push(down>up && down>0 ? down:0);
        }
        let sTR=tr.slice(-p).reduce((a,b)=>a+b,0), sP=dmP.slice(-p).reduce((a,b)=>a+b,0), sM=dmM.slice(-p).reduce((a,b)=>a+b,0);
        let diP=(sP/sTR)*100, diM=(sM/sTR)*100, dx=(Math.abs(diP-diM)/(diP+diM))*100;
        return { adx: dx, pdi: diP, mdi: diM };
    }
    function calcMACD(c, fast, slow, sig) {
        let emaFast = calcEMA(c, fast); 
        let emaSlow = calcEMA(c, slow);
        let emaF = [], emaS = [];
        let kF = 2/(fast+1), kS = 2/(slow+1);
        emaF[0]=c[0]; emaS[0]=c[0];
        for(let i=1; i<c.length; i++) {
            emaF[i] = c[i]*kF + emaF[i-1]*(1-kF);
            emaS[i] = c[i]*kS + emaS[i-1]*(1-kS);
        }
        let macdLine = [];
        for(let i=0; i<c.length; i++) macdLine.push(emaF[i]-emaS[i]);
        let signalLine = [];
        let kSig = 2/(sig+1);
        signalLine[0] = macdLine[0];
        for(let i=1; i<macdLine.length; i++) signalLine[i] = macdLine[i]*kSig + signalLine[i-1]*(1-kSig);
        let last = c.length-1;
        return { 
            macd: macdLine[last], 
            signal: signalLine[last], 
            histogram: macdLine[last] - signalLine[last] 
        };
    }

    function formatRSI(val) { return `<span class="${val>70?'text-red':(val<30?'text-green':'')}">${val.toFixed(2)}</span>`; }
    function formatADX(val) { return val>25 ? `<span class="text-gold">${val.toFixed(2)} (å¼·)</span>` : `<span style="color:#666">${val.toFixed(2)} (å¼±)</span>`; }
    function formatMACD(m) {
        let color = m.histogram > 0 ? 'text-green' : 'text-red';
        return `<span class="${color}">${m.histogram.toFixed(2)}</span>`;
    }
</script>

</body>
</html>
