<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3028 Cleanaway AI Analyst</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; background-color: #0b0e11; color: #eaecef; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header Style (Taiwan Red) */
        .header-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        h1 { 
            background: linear-gradient(to right, #e60012, #ff4d4d); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0 0 15px 0; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; text-align: center;
        }
        
        /* Controls */
        .controls-wrapper { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; position: relative; z-index: 100; }
        
        /* Search Box */
        .search-container { position: relative; width: 100%; max-width: 500px; }
        .search-box {
            display: flex; gap: 10px; background: #1e2329; padding: 10px 20px; border-radius: 50px; 
            border: 1px solid #e60012; box-shadow: 0 0 15px rgba(230, 0, 18, 0.2); align-items: center;
        }
        .search-input {
            background: transparent; border: none; color: #fff; font-size: 1.1rem; font-weight: bold; 
            flex-grow: 1; outline: none; text-transform: uppercase; letter-spacing: 1px;
        }
        .search-btn {
            background: linear-gradient(135deg, #e60012, #b3000e); color: #fff; border: none; 
            padding: 8px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.3s; white-space: nowrap;
        }
        .search-btn:hover { transform: scale(1.05); }

        /* TV Link */
        .tv-link-btn {
            display: inline-flex; align-items: center; gap: 8px; text-decoration: none;
            background: #2a2e39; color: #fff; padding: 8px 20px; border-radius: 20px;
            font-size: 0.9rem; font-weight: bold; border: 1px solid #434651; transition: 0.3s;
            margin-top: 5px;
        }
        .tv-link-btn:hover { background: #e60012; border-color: #e60012; }

        /* Buttons */
        .coin-switcher { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 5px; }
        .coin-btn { background: #1e2329; border: 1px solid #333; color: #848e9c; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; font-weight: bold; }
        .coin-btn:hover { border-color: #e60012; color: #fff; }
        .coin-btn.active { background: #e60012; color: #fff; border-color: #e60012; box-shadow: 0 0 10px rgba(230,0,18,0.3); }

        .tf-switcher { display: flex; gap: 5px; background: #161a1e; padding: 5px; border-radius: 8px; border: 1px solid #2b3139; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .tf-btn { background: transparent; border: 1px solid transparent; color: #848e9c; padding: 5px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: 0.3s; font-family: 'Roboto Mono', monospace; }
        .tf-btn.active { background: #2b3139; color: #e60012; border-color: #e60012; }

        /* Layout */
        .grid-top { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } /* åº•éƒ¨æ”¹ç‚ºå·¦å³å…©æ¬„ */
        
        .card { background: #1e2329; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 1px solid #2b3139; position: relative; display: flex; flex-direction: column; }
        
        .chart-box { height: 600px; } 
        .gauge-box { height: 600px; } 
        .bottom-card { height: 600px; }

        /* Titles & Badges */
        h3 { margin: 0 0 10px 0; color: #eee; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .badge { font-size: 0.75rem; background: #333; padding: 3px 8px; border-radius: 4px; color: #aaa; font-weight: normal; border: 1px solid #444; }
        .badge-red { background: rgba(230, 0, 18, 0.2); color: #ff4d4d; border-color: #e60012; }

        /* Gauge Controls (Bottom) */
        .gauge-controls { display: flex; gap: 5px; flex-wrap: wrap; }
        .gauge-btn { background: #2a2e39; color: #888; border: 1px solid #444; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .gauge-btn.active { background: #e60012; color: #fff; border-color: #e60012; font-weight: bold; }
        .gauge-btn:hover { color: #fff; border-color: #fff; }

        @media (max-width: 1200px) { 
            .grid-top, .grid-bottom { grid-template-columns: 1fr; } 
            .chart-box, .gauge-box, .bottom-card { height: 500px; } 
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>ğŸ‡¹ğŸ‡¼ å°è‚¡ AI æˆ°æƒ…å®¤ (v4.0)</h1>
        
        <div class="controls-wrapper">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="symbol-input" class="search-input" placeholder="è¼¸å…¥ä»£ç¢¼ (ä¾‹: 3028, 2330)..." autocomplete="off">
                    <button class="search-btn" onclick="triggerSearch()">ğŸ” åˆ†æ</button>
                </div>
            </div>

            <a id="tv-link" href="#" target="_blank" class="tv-link-btn">ğŸ”— å‰å¾€ TradingView è©³ç´°åˆ†æ</a>

            <div class="coin-switcher">
                <button class="coin-btn active" onclick="quickLoad('TWSE:3028', 'å¯å¯§è¡›')">3028 å¯å¯§è¡›</button>
                <button class="coin-btn" onclick="quickLoad('TWSE:8422', 'å¯å¯§è¡›æŠ•æ§')">8422 å¯å¯§è¡›æŠ•æ§</button>
                <button class="coin-btn" onclick="quickLoad('TWSE:2330', 'å°ç©é›»')">2330 å°ç©é›»</button>
                <button class="coin-btn" onclick="quickLoad('TAIFEX:CDF1!', 'å°ç©é›»æœŸè²¨')">å°ç©é›»æœŸè²¨</button>
                <button class="coin-btn" onclick="quickLoad('TAIFEX:TX1!', 'å°æŒ‡æœŸ')">å°æŒ‡æœŸ</button>
            </div>

            <div class="tf-switcher">
                <button class="tf-btn" onclick="switchGlobalTimeframe('60')">1H (ç•¶æ²–)</button>
                <button class="tf-btn" onclick="switchGlobalTimeframe('240')">4H (æ³¢æ®µ)</button>
                <button class="tf-btn active" onclick="switchGlobalTimeframe('D')">1D (æ—¥ç·š)</button>
                <button class="tf-btn" onclick="switchGlobalTimeframe('W')">1W (é€±ç·š)</button>
                <button class="tf-btn" onclick="switchGlobalTimeframe('M')">1M (æœˆç·š)</button>
            </div>
        </div>
    </div>

    <div class="grid-top">
        <div class="card chart-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <h3>ğŸ“ˆ <span class="coin-name" style="color:#e60012">å¯å¯§è¡›</span> æŠ€è¡“åˆ†æ</h3>
                <span class="badge badge-red">Auto Fib å•Ÿç”¨</span>
            </div>
            <div id="tv-chart-container" style="height:100%;width:100%"></div>
        </div>
        
        <div class="card gauge-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:5px;">
                <h3>âš¡ æŠ€è¡“æŒ‡é‡è¨Šè™Ÿ</h3>
                <div class="gauge-controls">
                    <button class="gauge-btn" onclick="manualUpdateGauge('60', this)">1H</button>
                    <button class="gauge-btn active" onclick="manualUpdateGauge('D', this)">1D</button>
                    <button class="gauge-btn" onclick="manualUpdateGauge('W', this)">1W</button>
                </div>
            </div>
            <div id="tv-gauge-container" style="height:100%;width:100%"></div>
        </div>
    </div>

    <div class="grid-bottom">
        <div class="card bottom-card">
            <h3>ğŸ“Š è²¡å‹™æ•¸æ“š (Financials) <span class="badge">ç‡Ÿæ”¶ / EPS / æç›Š</span></h3>
            <div id="tv-financials-container" style="height:100%;width:100%"></div>
        </div>

        <div class="card bottom-card">
            <h3>ğŸ¢ å…¬å¸æ¦‚æ³ (Profile)</h3>
            <div id="tv-profile-container" style="height:100%;width:100%"></div>
        </div>
    </div>

</div>

<script>
    // åˆå§‹åŒ–è¨­å®š
    let currentSymbol = 'TWSE:3028'; // é è¨­å¯å¯§è¡›
    let currentName = 'å¯å¯§è¡›';
    let currentTimeframe = 'D'; 

    // TradingView Widget Map
    const tfMap = {
        '60': '1H', '240': '4H', 'D': '1D', 'W': '1W', 'M': '1M'
    };

    window.onload = function() { 
        quickLoad('TWSE:3028', 'å¯å¯§è¡›');
        setupSearch();
    };

    // --- Search Logic ---
    function setupSearch() {
        const input = document.getElementById('symbol-input');
        input.addEventListener('keypress', function(e) {
            if(e.key === 'Enter') triggerSearch();
        });
    }

    function triggerSearch() {
        let val = document.getElementById('symbol-input').value.trim().toUpperCase();
        if(!val) return;

        let symbol = val;
        let name = val;

        // å°è‚¡ä»£ç¢¼è‡ªå‹•è£œå…¨
        if (/^\d{4}$/.test(val)) {
            symbol = `TWSE:${val}`;
            name = val;
        } else if (['TX1!', 'CDF1!'].includes(val) || val.startsWith('TX')) {
            if(!val.includes(':')) symbol = `TAIFEX:${val}`;
        }

        quickLoad(symbol, name);
    }

    // --- Loading Logic ---
    function quickLoad(symbol, name) {
        currentSymbol = symbol;
        currentName = name;
        
        document.querySelectorAll('.coin-name').forEach(el => el.innerText = name);
        document.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('active'));
        
        // Update Button State
        const btns = document.querySelectorAll('.coin-btn');
        for(let btn of btns) {
            if(btn.getAttribute('onclick').includes(symbol)) {
                btn.classList.add('active');
                break;
            }
        }

        // Update TV Link
        const cleanSymbol = symbol.split(':')[1] || symbol;
        const exchange = symbol.split(':')[0] === 'TAIFEX' ? 'TAIFEX' : 'TWSE';
        document.getElementById('tv-link').href = `https://tw.tradingview.com/symbols/${cleanSymbol}/?exchange=${exchange}`;

        refreshAll();
    }

    // --- Timeframe Logic ---
    function switchGlobalTimeframe(tf) {
        currentTimeframe = tf;
        
        // Update Top Buttons
        document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Sync Gauge Button
        document.querySelectorAll('.gauge-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.getAttribute('onclick').includes(`'${tf}'`)) btn.classList.add('active');
        });

        refreshAll();
    }

    function manualUpdateGauge(tf, btn) {
        document.querySelectorAll('.gauge-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadGauge(currentSymbol, tf);
    }

    function refreshAll() {
        loadChart(currentSymbol, currentTimeframe);
        loadGauge(currentSymbol, currentTimeframe);
        loadFinancials(currentSymbol);
        loadProfile(currentSymbol);
    }

    // --- Widget Loaders ---

    // 1. Chart (Auto Fib included)
    function loadChart(symbol, interval) {
        const container = document.getElementById('tv-chart-container');
        container.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'tradingview-widget-container';
        div.style.height = '100%'; div.style.width = '100%';
        div.innerHTML = '<div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>';
        
        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
        script.async = true;
        script.innerHTML = JSON.stringify({
            "autosize": true,
            "symbol": symbol,
            "interval": interval,
            "timezone": "Asia/Taipei",
            "theme": "dark",
            "style": "1",
            "locale": "zh_TW",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "studies": [
                "MASimple@tv-basicstudies", // MA
                "Stochastic@tv-basicstudies", // KD
                "AutoFibRetracement@tv-basicstudies" // Auto Fib
            ],
            "support_host": "https://www.tradingview.com"
        });
        div.appendChild(script);
        container.appendChild(div);
    }

    // 2. Gauge (Forced Height Fix)
    function loadGauge(symbol, interval) {
        const container = document.getElementById('tv-gauge-container');
        container.innerHTML = '';
        setTimeout(() => {
            const div = document.createElement('div');
            div.className = 'tradingview-widget-container';
            div.style.height = '100%'; div.style.width = '100%';
            div.innerHTML = '<div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>';
            
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "interval": interval,
                "width": "100%",
                "height": "100%",
                "isTransparent": true,
                "symbol": symbol,
                "showIntervalTabs": false,
                "displayMode": "single",
                "locale": "zh_TW",
                "colorTheme": "dark"
            });
            div.appendChild(script);
            container.appendChild(div);
        }, 50);
    }

    // 3. Financials (åŸºæœ¬é¢ - é©åˆå°è‚¡)
    function loadFinancials(symbol) {
        const container = document.getElementById('tv-financials-container');
        container.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'tradingview-widget-container';
        div.style.height = '100%'; div.style.width = '100%';
        div.innerHTML = '<div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>';
        
        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-financials.js';
        script.async = true;
        script.innerHTML = JSON.stringify({
            "colorTheme": "dark",
            "isTransparent": true,
            "displayMode": "regular",
            "width": "100%",
            "height": "100%",
            "symbol": symbol,
            "locale": "zh_TW"
        });
        div.appendChild(script);
        container.appendChild(div);
    }

    // 4. Company Profile (å…¬å¸æ¦‚æ³)
    function loadProfile(symbol) {
        const container = document.getElementById('tv-profile-container');
        container.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'tradingview-widget-container';
        div.style.height = '100%'; div.style.width = '100%';
        div.innerHTML = '<div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>';
        
        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js';
        script.async = true;
        script.innerHTML = JSON.stringify({
            "width": "100%",
            "height": "100%",
            "colorTheme": "dark",
            "isTransparent": true,
            "symbol": symbol,
            "locale": "zh_TW"
        });
        div.appendChild(script);
        container.appendChild(div);
    }
</script>

</body>
</html>
