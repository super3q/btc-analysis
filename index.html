<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto AI Quant Analyst (v5.0 Institutional)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root { --bg-dark: #0b0e11; --card-bg: #1e2329; --card-border: #2b3139; --primary: #0575e6; --accent: #00f260; --text-main: #eaecef; --text-dim: #848e9c; --green: #0ECB81; --red: #F6465D; }
        body { font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* Header & Search */
        .header-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        h1 { background: linear-gradient(to right, var(--accent), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 10px 0; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; font-size: 2rem; }
        .search-box { display: flex; gap: 10px; background: var(--card-bg); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(5, 117, 230, 0.2); width: 100%; max-width: 400px; }
        .search-input { background: transparent; border: none; color: #fff; flex-grow: 1; outline: none; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .search-btn { background: var(--primary); color: #fff; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        /* Controls */
        .control-bar { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-coin, .btn-tf { background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text-dim); padding: 6px 14px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-coin:hover, .btn-tf:hover { border-color: var(--primary); color: #fff; }
        .btn-coin.active, .btn-tf.active { background: var(--card-border); color: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* Grid Layout */
        .grid-main { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        @media (max-width: 1400px) { .grid-dashboard { grid-template-columns: 1fr; } }
        @media (max-width: 1000px) { .grid-main { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--card-border); padding: 20px; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; }
        .card-title { margin: 0; font-size: 1.1rem; color: #fff; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        /* Analysis Modules */
        .signal-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #555; }
        .signal-bull { border-left-color: var(--green); background: linear-gradient(90deg, rgba(14,203,129,0.1), transparent); }
        .signal-bear { border-left-color: var(--red); background: linear-gradient(90deg, rgba(246,70,93,0.1), transparent); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
        .stat-val { font-family: 'Roboto Mono', monospace; font-weight: bold; }
        
        /* Multi-TF Matrix */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: center; }
        .matrix-table th { color: var(--text-dim); padding: 8px; border-bottom: 1px solid var(--card-border); }
        .matrix-table td { padding: 8px; border-bottom: 1px solid #2b3139; font-weight: bold; }
        
        /* Order Book Bar */
        .ob-container { height: 24px; background: #333; border-radius: 4px; display: flex; overflow: hidden; margin-top: 5px; }
        .ob-fill-buy { background: var(--green); height: 100%; display: flex; align-items: center; padding-left: 5px; color: #000; font-size: 11px; font-weight: bold; transition: width 0.5s; }
        .ob-fill-sell { background: var(--red); height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; color: #fff; font-size: 11px; font-weight: bold; transition: width 0.5s; }

        /* Helpers */
        .text-green { color: var(--green); } .text-red { color: var(--red); } .text-gold { color: #F0B90B; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-green { background: rgba(14,203,129,0.2); color: var(--green); }
        .tag-red { background: rgba(246,70,93,0.2); color: var(--red); }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--accent), var(--primary)); z-index: 9999; display: none; }
    </style>
</head>
<body>

<div id="loading"></div>

<div class="container">
    <div class="header-section">
        <h1>Crypto AI Quant Analyst <span style="font-size:0.4em; color:var(--text-dim); vertical-align: middle; border:1px solid #333; padding:2px 6px; border-radius:4px;">v5.0 PRO</span></h1>
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" id="symbolInput" class="search-input" value="BTC" onkeypress="if(event.key==='Enter') loadNewSymbol()">
            <button class="search-btn" onclick="loadNewSymbol()">GO</button>
        </div>
        <div class="control-bar" style="margin-top:15px;">
            <button class="btn-coin active" onclick="quickLoad('BTC')">BTC</button>
            <button class="btn-coin" onclick="quickLoad('ETH')">ETH</button>
            <button class="btn-coin" onclick="quickLoad('SOL')">SOL</button>
            <button class="btn-coin" onclick="quickLoad('DOGE')">DOGE</button>
            <button class="btn-coin" onclick="quickLoad('BNB')">BNB</button>
            <span style="width:20px;"></span>
            <button class="btn-tf" onclick="changeTf('15m')">15m</button>
            <button class="btn-tf" onclick="changeTf('1h')">1H</button>
            <button class="btn-tf active" onclick="changeTf('4h')">4H</button>
            <button class="btn-tf" onclick="changeTf('1d')">1D</button>
        </div>
    </div>

    <div class="grid-main">
        <div class="card" style="height: 650px; padding:0;">
             <div class="tradingview-widget-container" id="tv-chart" style="height:100%;width:100%"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">âš¡ å¸‚å ´æ·±åº¦ & ç±Œç¢¼ (Order Flow)</span>
            </div>
            <div style="flex-grow: 1; display:flex; flex-direction: column; gap: 20px;">
                <div>
                    <div class="stat-row">
                        <span>è²·æ–¹æ›å–® (Bids)</span>
                        <span id="bid-pct" class="text-green">--%</span>
                    </div>
                    <div class="ob-container">
                        <div id="ob-bid-bar" class="ob-fill-buy" style="width:50%"></div>
                        <div id="ob-ask-bar" class="ob-fill-sell" style="width:50%"></div>
                    </div>
                    <div class="stat-row" style="margin-top:5px;">
                        <span id="ask-pct" class="text-red">--%</span>
                        <span>è³£æ–¹æ›å–® (Asks)</span>
                    </div>
                </div>

                <div>
                    <div class="card-title" style="font-size: 0.9rem; margin-bottom:10px;">ğŸ¯ æ©Ÿæ§‹æ¨è»¸é» (Pivot Points)</div>
                    <table class="matrix-table">
                        <tr><td class="text-red">R2</td><td id="p-r2">---</td></tr>
                        <tr><td class="text-red">R1</td><td id="p-r1">---</td></tr>
                        <tr><td class="text-gold">Pivot</td><td id="p-p">---</td></tr>
                        <tr><td class="text-green">S1</td><td id="p-s1">---</td></tr>
                        <tr><td class="text-green">S2</td><td id="p-s2">---</td></tr>
                    </table>
                </div>

                <div id="volatility-box" class="signal-box">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸŒ‹ æ³¢å‹•ç‡ç›£æ§ (BBW)</div>
                    <div class="stat-row">
                        <span>ç•¶å‰å¯¬åº¦:</span>
                        <span id="bbw-val" class="stat-val">---</span>
                    </div>
                    <div id="bbw-msg" style="font-size:0.8rem; color:var(--text-dim); line-height:1.4;">è¨ˆç®—ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-dashboard">
        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ§  AI è¶¨å‹¢è§£ç¢¼ (Trend Engine)</span>
                <span id="ai-score" class="tag" style="font-size:1rem;">N/A</span>
            </div>
            
            <div class="signal-box" id="main-signal-box">
                <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-dim);">ä¸»è¦ç­–ç•¥å»ºè­°</div>
                <div id="ai-strategy" style="font-size:1.1rem; font-weight:bold; margin-top:5px;">æ•¸æ“šè¼‰å…¥ä¸­...</div>
            </div>

            <div class="stat-row">
                <span>ADX è¶¨å‹¢å¼·åº¦ (14)</span>
                <span id="val-adx" class="stat-val">---</span>
            </div>
            <div style="font-size:0.75rem; color:#666; margin-bottom:10px; text-align:right;">*ADX>25 ç‚ºå¼·è¶¨å‹¢, <20 ç‚ºç›¤æ•´</div>
            <hr style="border:0; border-top:1px solid #333; width:100%; margin:10px 0;">
            
            <div class="stat-row">
                <span>RSI å‹•èƒ½ (14)</span>
                <span id="val-rsi" class="stat-val">---</span>
            </div>
            <div class="stat-row">
                <span>ATR çœŸå¯¦æ³¢å¹…</span>
                <span id="val-atr" class="stat-val">---</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸŒ å¤šé€±æœŸå…±æŒ¯é›·é” (Matrix)</span>
            </div>
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th>é€±æœŸ</th>
                        <th>EMA (25)</th>
                        <th>RSI ç‹€æ…‹</th>
                        <th>ä¿¡è™Ÿ</th>
                    </tr>
                </thead>
                <tbody id="matrix-body">
                    <tr><td colspan="4">æƒæä¸­...</td></tr>
                </tbody>
            </table>
            <div style="margin-top:15px; font-size:0.8rem; color:var(--text-dim);">
                * EMA ç”¨æ–¼åˆ¤æ–·è¶¨å‹¢æ–¹å‘<br>
                * å…±æŒ¯ï¼šç•¶æ‰€æœ‰é€±æœŸé¡è‰²ä¸€è‡´æ™‚ï¼Œå‹ç‡æœ€é«˜ã€‚
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">ğŸ”¬ Kç·šå‹æ…‹èˆ‡é¢¨éšª</span>
            </div>
            <div class="stat-row">
                <span>Kç·šå‹æ…‹è­˜åˆ¥:</span>
                <span id="pattern-res" class="text-gold" style="font-weight:bold;">ç„¡</span>
            </div>
            <div class="stat-row">
                <span>å»ºè­°æ­¢æä½ (2x ATR):</span>
                <span id="rec-sl" class="text-red stat-val">---</span>
            </div>
            
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <div style="margin-bottom:10px; font-weight:bold; color:var(--primary);">å¸‚å ´ç†±åŠ›åœ– (Money Flow)</div>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                    {
                    "symbol": "BINANCE:BTCUSDT",
                    "width": "100%",
                    "height": 180,
                    "locale": "zh_TW",
                    "dateRange": "12M",
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "autosize": false,
                    "largeChartUrl": ""
                    }
                    </script>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Configuration ---
    let state = {
        symbol: 'BTCUSDT',
        coin: 'BTC',
        tf: '4h', // UI display logic
        binanceInterval: '4h' // API param
    };

    const tfMap = {
        '15m': { bin: '15m', tv: '15' },
        '1h':  { bin: '1h',  tv: '60' },
        '4h':  { bin: '4h',  tv: '240' },
        '1d':  { bin: '1d',  tv: 'D' }
    };

    // --- Initialization ---
    window.onload = function() {
        loadChart();
        refreshData();
        setInterval(refreshData, 60000); // Auto refresh every min
    };

    function quickLoad(coin) {
        document.querySelectorAll('.btn-coin').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        state.coin = coin;
        state.symbol = coin + 'USDT';
        document.getElementById('symbolInput').value = coin;
        loadChart();
        refreshData();
    }

    function loadNewSymbol() {
        let val = document.getElementById('symbolInput').value.toUpperCase();
        if(!val) return;
        state.coin = val;
        state.symbol = val.endsWith('USDT') ? val : val + 'USDT';
        loadChart();
        refreshData();
    }

    function changeTf(tf) {
        document.querySelectorAll('.btn-tf').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        state.tf = tf;
        state.binanceInterval = tfMap[tf].bin;
        loadChart(); // Reload chart with new TF
        refreshData();
    }

    // --- TradingView Chart ---
    function loadChart() {
        const container = document.getElementById('tv-chart');
        container.innerHTML = ''; 
        const div = document.createElement('div');
        div.className = 'tradingview-widget-container__widget';
        div.style.height = '100%';
        div.style.width = '100%';
        container.appendChild(div);

        const script = document.createElement('script');
        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
        script.async = true;
        script.innerHTML = JSON.stringify({
            "autosize": true,
            "symbol": "BINANCE:" + state.symbol,
            "interval": tfMap[state.tf].tv,
            "timezone": "Asia/Taipei",
            "theme": "dark",
            "style": "1",
            "locale": "zh_TW",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "studies": [
                "MASimple@tv-basicstudies",
                "RSI@tv-basicstudies",
                "BB@tv-basicstudies", // Added Bollinger Bands
                "AverageDirectionalIndex@tv-basicstudies" // Added ADX
            ],
            "support_host": "https://www.tradingview.com"
        });
        container.appendChild(script);
    }

    // --- Data Fetching & Quant Logic ---
    async function refreshData() {
        document.getElementById('loading').style.display = 'block';
        
        try {
            // 1. Fetch Order Book
            fetchOrderBook();
            
            // 2. Main Analysis (Current TF)
            await runMainAnalysis();

            // 3. Multi-Timeframe Scan
            await runMatrixScan();

        } catch (e) {
            console.error(e);
        }
        
        document.getElementById('loading').style.display = 'none';
    }

    async function fetchOrderBook() {
        const res = await fetch(`https://api.binance.com/api/v3/depth?symbol=${state.symbol}&limit=20`);
        const data = await res.json();
        
        let bids = data.bids.reduce((a, b) => a + parseFloat(b[1]), 0);
        let asks = data.asks.reduce((a, b) => a + parseFloat(b[1]), 0);
        let total = bids + asks;
        
        let bidPct = (bids / total) * 100;
        let askPct = (asks / total) * 100;

        document.getElementById('bid-pct').innerText = bidPct.toFixed(1) + "%";
        document.getElementById('ask-pct').innerText = askPct.toFixed(1) + "%";
        document.getElementById('ob-bid-bar').style.width = bidPct + "%";
        document.getElementById('ob-ask-bar').style.width = askPct + "%";
    }

    async function runMainAnalysis() {
        // Fetch 200 candles for sufficient calculation
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${state.symbol}&interval=${state.binanceInterval}&limit=200`);
        const raw = await res.json();
        
        // Parse Data
        let closes = raw.map(x => parseFloat(x[4]));
        let highs = raw.map(x => parseFloat(x[2]));
        let lows = raw.map(x => parseFloat(x[3]));
        let currentPrice = closes[closes.length - 1];

        // Indicators
        let rsi = calcRSI(closes, 14);
        let adx = calcADX(highs, lows, closes, 14);
        let atr = calcATR(highs, lows, closes, 14);
        let bb = calcBB(closes, 20, 2);
        let ma25 = calcSMA(closes, 25);
        let ma99 = calcSMA(closes, 99);

        // Update UI Stats
        document.getElementById('val-rsi').innerHTML = formatRSI(rsi);
        document.getElementById('val-adx').innerHTML = formatADX(adx.adx);
        document.getElementById('val-atr').innerText = atr.toFixed(2);

        // --- Logic Engine (The "Brain") ---
        
        // 1. Bollinger Band Width (Squeeze Detector)
        let bbw = (bb.upper - bb.lower) / bb.middle;
        document.getElementById('bbw-val').innerText = bbw.toFixed(4);
        
        let bbwMsg = document.getElementById('bbw-msg');
        // Simple logic: if BBW is very low compared to recent history (simplified here as absolute threshold for demo, ideally relative)
        if (bbw < 0.05) { // Threshold varies by asset class, adjusted for crypto
            bbwMsg.innerHTML = "<span class='text-gold'>âš ï¸ æ³¢å‹•ç‡æ¥µåº¦å£“ç¸® (Squeeze)ï¼</span><br>å¤§è¡Œæƒ…å³å°‡çˆ†ç™¼ï¼Œè«‹ç•™æ„çªç ´æ–¹å‘ã€‚";
        } else if (bbw > 0.3) {
            bbwMsg.innerText = "æ³¢å‹•ç‡é«˜ï¼Œè¡Œæƒ…ç™¼æ•£ä¸­ï¼Œæ³¨æ„å›èª¿é¢¨éšªã€‚";
        } else {
            bbwMsg.innerText = "æ³¢å‹•ç‡æ­£å¸¸ï¼Œè¶¨å‹¢å»¶çºŒæ€§å°šå¯ã€‚";
        }

        // 2. Pivot Points (Traditional)
        let prevH = highs[highs.length-2];
        let prevL = lows[lows.length-2];
        let prevC = closes[closes.length-2];
        let pp = (prevH + prevL + prevC) / 3;
        
        document.getElementById('p-p').innerText = pp.toFixed(2);
        document.getElementById('p-r1').innerText = (2 * pp - prevL).toFixed(2);
        document.getElementById('p-r2').innerText = (pp + (prevH - prevL)).toFixed(2);
        document.getElementById('p-s1').innerText = (2 * pp - prevH).toFixed(2);
        document.getElementById('p-s2').innerText = (pp - (prevH - prevL)).toFixed(2);

        // 3. AI Strategy Decision
        let strategyBox = document.getElementById('main-signal-box');
        let strategyText = document.getElementById('ai-strategy');
        let scoreTag = document.getElementById('ai-score');
        let patternText = document.getElementById('pattern-res');
        
        // Stop Loss Recommendation
        document.getElementById('rec-sl').innerText = (currentPrice - (2 * atr)).toFixed(2) + " / " + (currentPrice + (2*atr)).toFixed(2);

        // Pattern Recognition (Simple Hammer/Shooting Star)
        let open = parseFloat(raw[raw.length-1][1]);
        let close = currentPrice;
        let high = highs[highs.length-1];
        let low = lows[lows.length-1];
        let body = Math.abs(close - open);
        let upperShadow = high - Math.max(close, open);
        let lowerShadow = Math.min(close, open) - low;
        
        if (lowerShadow > body * 2 && upperShadow < body * 0.5) patternText.innerText = "ğŸ”¨ éŒ˜é ­ (æ½›åœ¨åè½‰)";
        else if (upperShadow > body * 2 && lowerShadow < body * 0.5) patternText.innerText = "â˜„ï¸ æµæ˜Ÿ (é ‚éƒ¨å£“åŠ›)";
        else patternText.innerText = "ç„¡æ˜é¡¯Kç·šå‹æ…‹";

        // --- Core Strategy Logic ---
        let trendScore = 0;
        if (currentPrice > ma25) trendScore++;
        if (currentPrice > ma99) trendScore++;
        if (adx.adx > 25 && adx.pdi > adx.mdi) trendScore++; // Strong Trend
        if (adx.adx > 25 && adx.pdi < adx.mdi) trendScore--; // Strong Bear

        strategyBox.className = 'signal-box'; // reset
        
        if (adx.adx < 20) {
            // Ranging Market
            strategyText.innerHTML = "ğŸ’¤ å¸‚å ´ç›¤æ•´ä¸­ (Low ADX)<br><span style='font-size:0.9rem; font-weight:normal'>å»ºè­°ï¼šå€é–“æ“ä½œï¼ŒRSIè¶…è²·è³£å‡ºï¼Œè¶…è³£è²·å…¥ã€‚åˆ‡å‹¿è¿½æ¼²æ®ºè·Œã€‚</span>";
            scoreTag.innerText = "ä¸­æ€§"; scoreTag.className = "tag";
        } else {
            // Trending Market
            if (trendScore >= 2) {
                strategyBox.classList.add('signal-bull');
                strategyText.innerHTML = "ğŸš€ å¤šé ­å¼·å‹¢è¶¨å‹¢<br><span style='font-size:0.9rem; font-weight:normal'>å»ºè­°ï¼šå›èª¿è‡³ EMA25 é™„è¿‘å°‹æ‰¾è²·é»ã€‚åˆ‡å‹¿é€†å‹¢åšç©ºã€‚</span>";
                scoreTag.innerText = "å¼·å¤š"; scoreTag.className = "tag tag-green";
            } else if (trendScore <= -1) { // Basic bear logic check
                 strategyBox.classList.add('signal-bear');
                 strategyText.innerHTML = "ğŸ» ç©ºé ­æŒæ§<br><span style='font-size:0.9rem; font-weight:normal'>å»ºè­°ï¼šåå½ˆä¸éå£“åŠ›ä½åšç©ºã€‚æ”¯æ’ä½å¯èƒ½å¤±æ•ˆã€‚</span>";
                 scoreTag.innerText = "åç©º"; scoreTag.className = "tag tag-red";
            } else {
                 strategyText.innerHTML = "âš–ï¸ è¶¨å‹¢éœ‡ç›ªä¸æ˜<br><span style='font-size:0.9rem; font-weight:normal'>å»ºè­°ï¼šç­‰å¾… ADX æ–¹å‘æ˜ç¢ºæˆ–çªç ´ Pivot R1/S1ã€‚</span>";
                 scoreTag.innerText = "è§€å¯Ÿ"; scoreTag.className = "tag";
            }
        }
    }

    async function runMatrixScan() {
        const tfs = ['15m', '1h', '4h', '1d'];
        let html = '';
        
        for (let t of tfs) {
            // Using minimal limit to save bandwidth, just need recent 30 for EMA/RSI
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${state.symbol}&interval=${t}&limit=50`);
            const raw = await res.json();
            let c = raw.map(x => parseFloat(x[4]));
            let cur = c[c.length-1];
            
            let ema25 = calcEMA(c, 25);
            let rsi = calcRSI(c, 14);
            
            let trend = cur > ema25 ? 'bull' : 'bear';
            let trendColor = trend === 'bull' ? 'text-green' : 'text-red';
            let trendIcon = trend === 'bull' ? 'â†—' : 'â†˜';
            
            let rsiClass = rsi > 70 ? 'tag-red' : (rsi < 30 ? 'tag-green' : '');
            let rsiTxt = rsi.toFixed(0);
            
            let sig = 'ä¸­æ€§';
            let sigClass = '';
            if(trend === 'bull' && rsi < 70) { sig = 'çœ‹å¤š'; sigClass='text-green'; }
            else if(trend === 'bear' && rsi > 30) { sig = 'çœ‹ç©º'; sigClass='text-red'; }
            else if(rsi > 70) { sig = 'è¶…è²·'; sigClass='text-gold'; }
            else if(rsi < 30) { sig = 'è¶…è³£'; sigClass='text-green'; }
            
            html += `
                <tr>
                    <td style="color:#fff">${t.toUpperCase()}</td>
                    <td class="${trendColor}">${trendIcon} ${ema25.toFixed(2)}</td>
                    <td><span class="tag ${rsiClass}">${rsiTxt}</span></td>
                    <td class="${sigClass}">${sig}</td>
                </tr>
            `;
        }
        document.getElementById('matrix-body').innerHTML = html;
    }

    // --- Math Helpers ---
    function calcSMA(data, window) {
        if(data.length < window) return 0;
        let sum = 0;
        for(let i=data.length-window; i<data.length; i++) sum += data[i];
        return sum / window;
    }

    function calcEMA(data, window) {
        let k = 2 / (window + 1);
        let ema = data[0];
        for (let i = 1; i < data.length; i++) {
            ema = data[i] * k + ema * (1 - k);
        }
        return ema;
    }

    function calcRSI(closes, period) {
        let gains = 0, losses = 0;
        for (let i = closes.length - period - 1; i < closes.length - 1; i++) {
            let diff = closes[i + 1] - closes[i];
            if (diff > 0) gains += diff;
            else losses -= diff;
        }
        let avgGain = gains / period;
        let avgLoss = losses / period;
        let rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
    }
    
    function calcATR(highs, lows, closes, period) {
        let trs = [];
        for(let i=1; i<highs.length; i++) {
            let tr = Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1]));
            trs.push(tr);
        }
        // Simple Average of TR for ATR approx
        let sum = 0;
        for(let i=trs.length-period; i<trs.length; i++) sum += trs[i];
        return sum / period;
    }

    function calcBB(closes, period, stdDevMultiplier) {
        let sma = calcSMA(closes, period);
        let sumSqDiff = 0;
        for(let i=closes.length-period; i<closes.length; i++) {
            sumSqDiff += Math.pow(closes[i] - sma, 2);
        }
        let stdDev = Math.sqrt(sumSqDiff / period);
        return { middle: sma, upper: sma + (stdDev * stdDevMultiplier), lower: sma - (stdDev * stdDevMultiplier) };
    }

    // Simplified ADX Calculation
    function calcADX(highs, lows, closes, period) {
        let tr = [], dmP = [], dmM = [];
        for(let i=1; i<highs.length; i++) {
            tr.push(Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1])));
            let up = highs[i] - highs[i-1];
            let down = lows[i-1] - lows[i];
            dmP.push((up > down && up > 0) ? up : 0);
            dmM.push((down > up && down > 0) ? down : 0);
        }
        // Smooth
        let smoothTR = tr.slice(-period).reduce((a,b)=>a+b,0);
        let smoothP = dmP.slice(-period).reduce((a,b)=>a+b,0);
        let smoothM = dmM.slice(-period).reduce((a,b)=>a+b,0);
        
        let diP = (smoothP/smoothTR)*100;
        let diM = (smoothM/smoothTR)*100;
        let dx = (Math.abs(diP-diM) / (diP+diM)) * 100;
        
        // Return mostly simplified recent value, real ADX requires smoothing DX over time
        return { adx: dx, pdi: diP, mdi: diM }; 
    }

    function formatRSI(val) {
        let cls = val > 70 ? 'text-red' : (val < 30 ? 'text-green' : '');
        return `<span class="${cls}">${val.toFixed(2)}</span>`;
    }
    
    function formatADX(val) {
        let txt = val.toFixed(2);
        if(val < 20) return `<span style="color:#888">${txt} (å¼±)</span>`;
        if(val > 25) return `<span class="text-gold" style="font-weight:bold">${txt} (å¼·)</span>`;
        return txt;
    }
</script>

</body>
</html>
